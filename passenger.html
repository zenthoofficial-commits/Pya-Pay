
<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pyapay Passenger</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        html, body {
            overscroll-behavior-y: contain;
            height: 100dvh; width: 100vw;
            margin: 0; padding: 0;
            overflow: hidden;
            background-color: #f8fafc; /* blue-50/slate-50ish */
        }
        #map { height: 100%; width: 100%; z-index: 0; background-color: #e2e8f0; }
        .leaflet-bottom, .leaflet-top { z-index: 5; }
        .leaflet-control-container .leaflet-routing-container { display: none; }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-in-out forwards; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none !important; }
        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .chat-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 9999px;
            min-width: 20px;
            height: 20px;
            padding: 0 4px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #ffffff;
            z-index: 20;
        }
        #loading-overlay {
            position: fixed; inset: 0; background-color: #ffffff; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loading-spinner {
            border: 4px solid #eff6ff; border-left-color: #3b82f6;
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active { border-color: #3b82f6; color: #3b82f6; }
        .star-rating span { font-size: 2rem; cursor: pointer; color: #cbd5e1; transition: color 0.2s; }
        .star-rating span.active { color: #f59e0b; }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading-overlay">
        <h1 class="text-3xl font-bold text-blue-500 mb-4 animate-pulse">Pyapay</h1>
        <div class="loading-spinner"></div>
    </div>

    <div id="map"></div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden absolute inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 animate-fade-in">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-5xl font-bold text-blue-600 mb-2">Pyapay</h1>
            <p class="text-slate-500 mb-8">Passenger App</p>
            <div class="bg-white border border-slate-200 shadow-xl rounded-2xl p-6 space-y-4">
                <input id="passenger-name" type="text" placeholder="သင့်အမည်" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input id="passenger-phone" type="tel" placeholder="ဖုန်းနံပါတ်" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="login-button" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">စတင်အသုံးပြုမည်</button>
            </div>
        </div>
    </div>
    
    <!-- Main UI Container -->
    <div id="main-ui" class="hidden">
        <!-- Header -->
        <header id="main-header" class="absolute top-4 left-4 right-4 z-10 flex justify-between items-center pointer-events-none">
             <button id="menu-button" class="pointer-events-auto bg-white p-3 rounded-full shadow-lg border border-slate-200 hover:bg-slate-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <button id="profile-button" class="pointer-events-auto bg-white p-3 rounded-full shadow-lg border border-slate-200 hover:bg-slate-50">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-600"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </button>
        </header>

        <!-- Recenter Button -->
        <button id="recenter-btn" class="absolute bottom-64 right-4 z-20 bg-white text-blue-600 p-3 rounded-full shadow-lg border border-slate-200 hover:bg-slate-50 transition">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>
        </button>

        <!-- Nearby Drivers Panel (Left Menu) -->
        <div id="nearby-drivers-panel" class="hidden absolute top-0 left-0 bottom-0 w-full md:w-80 bg-white p-4 z-20 animate-fade-in border-r border-slate-200 shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-4 flex-shrink-0">
                <h2 class="text-xl font-bold text-slate-800">အနီးအနားမှ ကားများ</h2>
                 <button id="close-drivers-panel" class="p-1 rounded-full hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div id="drivers-list" class="flex-1 overflow-y-auto space-y-4 pr-1 pb-4">
                <p class="text-slate-400 text-center py-8">ယာဉ်မောင်းများ ရှာဖွေနေသည်...</p>
            </div>
        </div>

        <!-- Panels -->
        <div id="search-panel" class="absolute bottom-0 left-0 right-0 bg-white p-4 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] animate-slide-up z-10">
            <h2 class="text-xl font-bold mb-4 text-center text-slate-800">ဘယ်သွားမလဲ?</h2>
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <input id="destination-input" type="text" placeholder="သွားလိုသောနေရာကို ရိုက်ထည့်ပါ" class="w-full bg-white border border-slate-200 rounded-lg p-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div id="search-results" class="mt-2 max-h-48 overflow-y-auto"></div>
            </div>
        </div>

        <div id="confirm-panel" class="hidden absolute bottom-0 left-0 right-0 bg-white p-4 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] animate-slide-up z-10">
            <div id="direct-booking-alert" class="hidden bg-amber-50 border border-amber-200 text-amber-700 p-2 rounded-lg text-center text-sm mb-3">
                <span class="font-bold">Direct Booking:</span> Priority request to selected driver.
            </div>
            <div id="vehicle-options" class="flex justify-around mb-4 bg-slate-100 p-1 rounded-full">
                <button data-type="Normal" class="vehicle-btn flex-1 py-2 px-4 rounded-full text-center font-semibold bg-white text-slate-800 shadow-sm">Normal</button>
                <button data-type="Premium" class="vehicle-btn flex-1 py-2 px-4 rounded-full text-center font-semibold text-slate-500">Premium</button>
            </div>
            <div class="text-center mb-3">
                <h2 class="text-2xl font-bold text-slate-800" id="fare-display"></h2>
                <p class="text-slate-500" id="trip-info-display"></p>
            </div>
            <div class="flex gap-2 mb-4">
                <select id="payment-method" class="w-1/2 bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm text-slate-800 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="Cash">Cash</option>
                    <option value="KBZPay">KBZPay</option>
                    <option value="WavePay">WavePay</option>
                </select>
                <input id="promo-code" type="text" placeholder="Promo Code" class="w-1/2 bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm text-slate-800 focus:outline-none focus:ring-1 focus:ring-blue-500">
            </div>
            <div class="flex space-x-2">
                <button id="schedule-ride-button" class="w-1/2 bg-slate-200 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-300 transition">အချိန်ကြို</button>
                <button id="confirm-ride-button" class="w-1/2 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">ချက်ချင်းခေါ်မည်</button>
            </div>
            <button id="cancel-search-button" class="w-full bg-transparent text-slate-400 font-semibold py-2 mt-2 rounded-lg hover:text-slate-600 transition">ပယ်ဖျက်မည်</button>
        </div>

        <div id="trip-status-panel" class="hidden absolute bottom-0 left-0 right-0 bg-white p-4 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] animate-slide-up z-10"></div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profile-modal" class="hidden absolute inset-0 bg-black/60 z-40 animate-fade-in flex justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md h-full max-h-[95vh] rounded-2xl shadow-2xl flex flex-col">
            <header class="p-4 flex justify-between items-center border-b border-slate-100">
                <h2 class="text-xl font-bold text-slate-800">Profile</h2>
                <button id="close-profile-button" class="p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </header>
            <div class="p-4 flex items-center gap-4 border-b border-slate-100 bg-slate-50">
                <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-2xl font-bold text-blue-600" id="profile-initial"></div>
                <div>
                    <h3 id="profile-name" class="text-lg font-bold text-slate-800"></h3>
                    <p id="profile-phone" class="text-sm text-slate-500"></p>
                </div>
            </div>
            <div class="flex border-b border-slate-100">
                <button data-tab="history" class="profile-tab flex-1 p-3 font-semibold border-b-2 tab-active transition-colors">History</button>
                <button data-tab="favorites" class="profile-tab flex-1 p-3 font-semibold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors">Favorites</button>
                <button data-tab="settings" class="profile-tab flex-1 p-3 font-semibold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors">Settings</button>
            </div>
            <div id="history-content" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar"></div>
            <div id="favorites-content" class="hidden flex-1 overflow-y-auto p-4 space-y-4">
                <div>
                    <label class="text-sm text-slate-500 font-bold">Home</label>
                    <input id="home-address-input" type="text" placeholder="Address" class="w-full mt-1 bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm text-slate-800">
                </div>
                 <div>
                    <label class="text-sm text-slate-500 font-bold">Work</label>
                    <input id="work-address-input" type="text" placeholder="Address" class="w-full mt-1 bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm text-slate-800">
                </div>
                <button id="save-favorites-button" class="w-full bg-blue-600 text-white font-bold py-2 mt-2 rounded-lg shadow">Save</button>
            </div>
            <div id="settings-content" class="hidden flex-1 overflow-y-auto p-4 space-y-4">
                 <button id="logout-button" class="w-full bg-red-50 text-red-600 font-bold py-3 mt-6 rounded-lg border border-red-100 hover:bg-red-100">Log Out</button>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="rating-modal" class="hidden absolute inset-0 bg-black/70 z-50 flex justify-center items-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 text-center shadow-2xl">
            <h3 class="text-xl font-bold text-slate-800 mb-2">ခရီးစဉ် ပြီးဆုံးပါပြီ</h3>
            <p class="text-slate-500 mb-6">ယာဉ်မောင်းအား အမှတ်ပေးပါ</p>
            <div class="star-rating flex justify-center gap-2 mb-6" id="star-rating">
                <span data-val="1">★</span><span data-val="2">★</span><span data-val="3">★</span><span data-val="4">★</span><span data-val="5">★</span>
            </div>
            <button id="submit-rating-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-blue-700">အမှတ်ပေးမည်</button>
            <button id="skip-rating-btn" class="mt-3 text-slate-400 hover:text-slate-600 font-semibold text-sm">ကျော်သွားမည်</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="chat-modal" class="hidden"></div>
    <div id="schedule-modal" class="hidden absolute inset-0 bg-black/60 z-30 flex justify-center items-center p-4 backdrop-blur-sm"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, off, remove, query, orderByChild, equalTo, onChildAdded, serverTimestamp, update, limitToLast, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Separate App Name to avoid conflict with Admin Panel if run in same browser
        const firebaseConfig = { apiKey: "AIzaSyB7zSpZMYgS2SChtyFrUvvp0txPutecF3g", authDomain: "zenstride.firebaseapp.com", databaseURL: "https://zenstride-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "zenstride", storageBucket: "zenstride.firebasestorage.app", messagingSenderId: "588697035765", appId: "1:588697035765:web:9411ea5aa9588ceb7d36bc" };
        const app = initializeApp(firebaseConfig, "passengerApp"); 
        const auth = getAuth(app);
        const db = getDatabase(app);

        let map, userMarker, routeControl, driverRouteControl;
        let activeDriverMarker = null; // Changed from driverMarkers object to single marker
        let currentUser = null, passengerInfo = null, currentLocation = null, activeTrip = null;
        let pickupLocation = null, dropoffLocation = null;
        let tripListener = null, driverLocationListener = null, chatListener = null, nearbyDriversListener = null;
        let currentFareDetails = { distance: 0, duration: 0, baseFare: 0 };
        let selectedVehicleType = 'Normal';
        let selectedDriverForBooking = null;
        let unreadMessages = 0;
        let driversListLastUpdate = 0;
        let pricingSettings = { baseFare: 1500, pricePerKm: 500 };
        let currentRating = 0;
        
        // Sounds
        const messageSound = new Audio("data:audio/wav;base64,UklGRlFFT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUFENQDI7PAA8gDwAPUA9ADzAPIBAAIEAwQDBAIBAAAAAP8A/gD4APUA8gDxAPIA8gDzAO8A7ADoAN4A2gDYANoA3gDkAO0A9AEAAv9//wD+APwA+gD7AP0AAQIDBAUGBwgJCgsMDQ4PDxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w==");
        const tripAcceptSound = new Audio("data:audio/wav;base64,UklGRlFFT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUFENQDI7PAA8gDwAPUA9ADzAPIBAAIEAwQDBAIBAAAAAP8A/gD4APUA8gDxAPIA8gDzAO8A7ADoAN4A2gDYANoA3gDkAO0A9AEAAv9//wD+APwA+gD7AP0AAQIDBAUGBwgJCgsMDQ4PDxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w==");
        function playDoubleBeep() {
            messageSound.currentTime = 0; messageSound.play();
            setTimeout(() => { messageSound.currentTime = 0; messageSound.play(); }, 200);
        }

        const dom = {
            loadingOverlay: document.getElementById('loading-overlay'),
            loginScreen: document.getElementById('login-screen'),
            mainUI: document.getElementById('main-ui'),
            mainHeader: document.getElementById('main-header'),
            searchPanel: document.getElementById('search-panel'),
            confirmPanel: document.getElementById('confirm-panel'),
            tripStatusPanel: document.getElementById('trip-status-panel'),
            profileModal: document.getElementById('profile-modal'),
            chatModal: document.getElementById('chat-modal'),
            destinationInput: document.getElementById('destination-input'),
            searchResults: document.getElementById('search-results'),
            vehicleOptions: document.getElementById('vehicle-options'),
            promoCodeInput: document.getElementById('promo-code'),
            nearbyDriversPanel: document.getElementById('nearby-drivers-panel'),
            driversList: document.getElementById('drivers-list'),
            directBookingAlert: document.getElementById('direct-booking-alert'),
            recenterBtn: document.getElementById('recenter-btn'),
            ratingModal: document.getElementById('rating-modal')
        };
        
        const userIcon = L.divIcon({ html: `<div class="w-6 h-6 bg-blue-500 rounded-full border-2 border-white pulse shadow-lg"></div>`, className: '', iconSize: [24, 24], iconAnchor: [12, 12] });
        const driverIcon = (rotation) => L.divIcon({ html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#16a34a" class="w-8 h-8 drop-shadow-md" style="transform: rotate(${rotation || 0}deg);"><path d="M19,5.5C19,4.4,18.1,3.5,17,3.5H7C5.9,3.5,5,4.4,5,5.5V16.5C5,17.6,5.9,18.5,7,18.5H6C5.4,18.5,5,18.9,5,19.5S5.4,20.5,6,20.5H18C18.6,20.5,19,20.1,19,19.5S18.6,18.5,18,18.5H17C18.1,18.5,19,17.6,19,16.5V5.5M17,16.5H7V5.5H17V16.5M8,15.5A1.5,1.5 0 0,0 9.5,17A1.5,1.5 0 0,0 11,15.5A1.5,1.5 0 0,0 9.5,14A1.5,1.5 0 0,0 8,15.5M13,15.5A1.5,1.5 0 0,0 14.5,17A1.5,1.5 0 0,0 16,15.5A1.5,1.5 0 0,0 14.5,14A1.5,1.5 0 0,0 13,15.5M7,8.5H17V11.5H7V8.5Z" /></svg>`, className: '', iconSize: [32, 32], iconAnchor: [16, 16] });

        function initApp() {
            initMap();
            setupAuthListener();
            setupEventListeners();
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([16.8409, 96.1735], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            navigator.geolocation.watchPosition(pos => {
                currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                if (!map.getBounds().contains(L.latLng(currentLocation))) map.setView(currentLocation, 16);
                if (!userMarker) userMarker = L.marker(currentLocation, { icon: userIcon }).addTo(map);
                else userMarker.setLatLng(currentLocation);
            }, console.warn, { enableHighAccuracy: true });
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async user => {
                dom.loadingOverlay.classList.remove('hidden');
                if (user) {
                    currentUser = user;
                    const snapshot = await get(ref(db, `passengers/${user.uid}`));
                    if (snapshot.exists()) {
                        passengerInfo = snapshot.val();
                        dom.loginScreen.classList.add('hidden');
                        dom.mainUI.classList.remove('hidden');
                        fetchSettings();
                        await checkForActiveTrip(user.uid);
                    } else {
                        // User exists but no profile (rare case or first partial login)
                        dom.loginScreen.classList.remove('hidden');
                        dom.mainUI.classList.add('hidden');
                    }
                } else {
                    dom.loginScreen.classList.remove('hidden');
                    dom.mainUI.classList.add('hidden');
                    if (nearbyDriversListener) off(ref(db, `driverLocations`), 'value', nearbyDriversListener);
                }
                setTimeout(() => dom.loadingOverlay.classList.add('hidden'), 500);
            });
        }
        
        async function fetchSettings() {
             const snap = await get(ref(db, 'settings/fees'));
             if(snap.exists()) {
                 const data = snap.val();
                 pricingSettings = { 
                    baseFare: data.baseFare || 1500, 
                    pricePerKm: data.pricePerKm || 500 
                 };
             }
        }
        
        async function checkForActiveTrip(uid) {
            const activeTripsQuery = query(ref(db, 'trips'), orderByChild('passengerId'), equalTo(uid), limitToLast(1));
            const snapshot = await get(activeTripsQuery);
            if (snapshot.exists()) {
                const trips = snapshot.val();
                const tripId = Object.keys(trips)[0];
                const tripData = trips[tripId];
                if (['accepted', 'at_pickup', 'to_dropoff', 'pending'].includes(tripData.status)) {
                    activeTrip = { id: tripId, ...tripData };
                    dom.searchPanel.classList.add('hidden');
                    dom.confirmPanel.classList.add('hidden');
                    dom.tripStatusPanel.classList.remove('hidden');
                    if(tripData.status === 'pending') updateTripStatusUI('searching');
                    else listenToTripUpdates(tripId);
                    return;
                }
            }
            startAppFlow();
        }

        function setupEventListeners() {
            document.getElementById('login-button').addEventListener('click', handleLogin);
            document.getElementById('profile-button').addEventListener('click', showProfile);
            document.getElementById('close-profile-button').addEventListener('click', () => dom.profileModal.classList.add('hidden'));
            document.getElementById('menu-button').addEventListener('click', () => {
                dom.nearbyDriversPanel.classList.remove('hidden');
                refreshDriversList();
            });
            document.getElementById('close-drivers-panel').addEventListener('click', () => dom.nearbyDriversPanel.classList.add('hidden'));
            dom.destinationInput.addEventListener('input', handleAddressSearch);
            document.getElementById('confirm-ride-button').addEventListener('click', () => handleConfirmRide(false));
            document.getElementById('schedule-ride-button').addEventListener('click', showScheduleModal);
            document.getElementById('cancel-search-button').addEventListener('click', resetToMainView);
            dom.vehicleOptions.addEventListener('click', (e) => {
                if(e.target.matches('.vehicle-btn')) handleVehicleSelection(e.target);
            });
            dom.promoCodeInput.addEventListener('input', updateFareDisplay);
            document.querySelectorAll('.profile-tab').forEach(tab => tab.addEventListener('click', handleTabSwitch));
            document.getElementById('save-favorites-button').addEventListener('click', saveFavorites);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            dom.recenterBtn.addEventListener('click', () => {
                if (currentLocation && map) map.setView(currentLocation, 17);
            });
            
            // Rating
            document.querySelectorAll('.star-rating span').forEach(star => {
                star.onclick = (e) => {
                    const val = parseInt(e.target.dataset.val);
                    currentRating = val;
                    document.querySelectorAll('.star-rating span').forEach(s => {
                         s.classList.toggle('active', parseInt(s.dataset.val) <= val);
                    });
                }
            });
            document.getElementById('submit-rating-btn').onclick = submitRating;
            document.getElementById('skip-rating-btn').onclick = () => { dom.ratingModal.classList.add('hidden'); resetToMainView(); };
        }

        function handleLogout() { signOut(auth).then(() => window.location.reload()); }
        
        function handleTabSwitch(e) {
            const tabName = e.currentTarget.dataset.tab;
            document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('tab-active'));
            e.currentTarget.classList.add('tab-active');
            ['history-content', 'favorites-content', 'settings-content'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
        }

        async function handleLogin() {
            const name = document.getElementById('passenger-name').value;
            const phone = document.getElementById('passenger-phone').value;
            if (!name || !phone) return alert('အမည်နှင့် ဖုန်းနံပါတ် ဖြည့်စွက်ပေးပါ။');
            
            try {
                const userCredential = await signInAnonymously(auth);
                passengerInfo = { name, phone };
                await set(ref(db, `passengers/${userCredential.user.uid}`), passengerInfo);
                // onAuthStateChanged will handle the rest
            } catch (e) {
                alert("Login Error: " + e.message);
            }
        }

        function startAppFlow() { 
            resetToMainView();
            listenForNearbyDrivers();
        }

        function listenForNearbyDrivers() {
            const driversRef = ref(db, `driverLocations`);
            if (nearbyDriversListener) off(driversRef, 'value', nearbyDriversListener);

            nearbyDriversListener = onValue(driversRef, (snapshot) => {
                const driversData = snapshot.val() || {};
                
                // NOTE: We do NOT add markers to the map here anymore.
                // We only use this data to calculate nearby drivers for the list.
                
                if(!dom.nearbyDriversPanel.classList.contains('hidden')) {
                    const now = Date.now();
                    if (now - driversListLastUpdate > 2000) { 
                         refreshDriversList(driversData);
                         driversListLastUpdate = now;
                    }
                }
            });
        }

        async function refreshDriversList(cachedLocations = null) {
            let locations = cachedLocations;
            if (!locations) {
                const snap = await get(ref(db, 'driverLocations'));
                locations = snap.val() || {};
            }

            const driverPromises = Object.entries(locations).map(async ([driverId, loc]) => {
                if (!currentLocation) return null;
                const distMeters = L.latLng(currentLocation).distanceTo([loc.lat, loc.lng]);
                const distKm = (distMeters / 1000).toFixed(1);
                const duration = Math.ceil(distKm * 2); 
                const profileSnap = await get(ref(db, `drivers/${driverId}`));
                const profile = profileSnap.val() || { name: 'Unknown', carModel: 'Car', carPlate: 'N/A' };
                // Calculate estimated price based on distance using dynamic settings
                const estPrice = Math.max(2000, Math.round((pricingSettings.baseFare + parseFloat(distKm) * pricingSettings.pricePerKm)/100)*100);
                
                return { id: driverId, ...loc, ...profile, distKm, duration, price: estPrice };
            });

            const drivers = (await Promise.all(driverPromises)).filter(d => d !== null);
            drivers.sort((a, b) => parseFloat(a.distKm) - parseFloat(b.distKm));

            dom.driversList.innerHTML = ''; // Clear to prevent ghosting
            
            if (drivers.length === 0) {
                 dom.driversList.innerHTML = `<p class="text-slate-400 text-center py-8">အနီးအနားတွင် ယာဉ်မောင်းမရှိပါ။</p>`;
            } else {
                 drivers.forEach(d => {
                    const statusColor = d.isAvailable ? 'text-green-500' : 'text-red-500';
                    const statusText = d.isAvailable ? 'Available' : 'Busy';
                    const opacity = d.isAvailable ? 'opacity-100' : 'opacity-60';
                    const cursor = d.isAvailable ? 'cursor-pointer hover:bg-slate-50' : 'cursor-not-allowed';

                    const card = document.createElement('div');
                    card.className = `bg-white p-3 rounded-xl border border-slate-200 ${cursor} ${opacity} transition-colors shadow-sm`;
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                 <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center border border-slate-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                 </div>
                                 <div>
                                    <h3 class="font-bold text-slate-800">${d.name}</h3>
                                    <p class="text-xs text-slate-500">${d.carModel} • <span class="text-blue-600 font-mono font-bold">${d.carPlate}</span></p>
                                 </div>
                            </div>
                            <span class="text-xs font-bold ${statusColor}">${statusText}</span>
                        </div>
                        <div class="mt-3 flex justify-between items-center text-sm border-t border-slate-100 pt-2">
                            <div class="flex gap-4">
                                <div><p class="text-slate-400 text-xs">Distance</p><p class="font-semibold text-slate-700">${d.distKm} km</p></div>
                                <div><p class="text-slate-400 text-xs">Est. Price</p><p class="font-bold text-green-600">~${d.price.toLocaleString()} Ks</p></div>
                            </div>
                            ${d.isAvailable ? `<button class="select-driver-btn bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded hover:bg-blue-500 shadow">ရွေးချယ်မည်</button>` : ''}
                        </div>
                    `;
                    
                    if (d.isAvailable) {
                        card.querySelector('.select-driver-btn').onclick = (e) => {
                            e.stopPropagation();
                            selectedDriverForBooking = d.id;
                            dom.nearbyDriversPanel.classList.add('hidden');
                            dom.directBookingAlert.classList.remove('hidden');
                            alert(`${d.name} ကို ရွေးချယ်လိုက်ပါပြီ။ ခရီးစဉ်စတင်ရန် သွားလိုသောနေရာကို ရှာဖွေပါ။`);
                            dom.destinationInput.focus();
                        };
                    }
                    dom.driversList.appendChild(card);
                });
            }
        }

        let searchTimeout;
        function handleAddressSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const query = dom.destinationInput.value;
                if (query.length < 3) return;
                dom.searchResults.innerHTML = `<p class="text-slate-400 p-2">ရှာဖွေနေသည်...</p>`;
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=mm&addressdetails=1`);
                    const results = await response.json();
                    dom.searchResults.innerHTML = '';
                    if (results.length > 0) {
                        results.slice(0, 5).forEach(place => {
                            const resultDiv = document.createElement('div');
                            resultDiv.className = 'p-2 border-b border-slate-100 cursor-pointer hover:bg-slate-50 text-slate-700';
                            resultDiv.innerText = place.display_name;
                            resultDiv.onclick = () => selectDestination(place);
                            dom.searchResults.appendChild(resultDiv);
                        });
                    } else dom.searchResults.innerHTML = `<p class="text-slate-400 p-2">ရလဒ်မရှိပါ</p>`;
                } catch(e) { dom.searchResults.innerHTML = `<p class="text-red-400 p-2">Error searching.</p>`; }
            }, 500);
        }

        async function selectDestination(place) {
            const pickupSnap = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLocation.lat}&lon=${currentLocation.lng}`);
            const pickupData = await pickupSnap.json();
            
            pickupLocation = { lat: currentLocation.lat, lng: currentLocation.lng, address: pickupData.display_name || "Current Location" };
            dropoffLocation = { lat: parseFloat(place.lat), lng: parseFloat(place.lon), address: place.display_name };

            if (routeControl) map.removeControl(routeControl);
            routeControl = L.routing.control({
                waypoints: [ L.latLng(pickupLocation.lat, pickupLocation.lng), L.latLng(dropoffLocation.lat, dropoffLocation.lng) ],
                createMarker: () => null,
                lineOptions: { styles: [{color: '#3b82f6', opacity: 0.8, weight: 6}] }
            }).addTo(map);

            routeControl.on('routesfound', function(e) {
                const route = e.routes[0];
                currentFareDetails.distance = route.summary.totalDistance / 1000;
                currentFareDetails.duration = Math.round(route.summary.totalTime / 60);
                updateFareDisplay();
                document.getElementById('trip-info-display').innerText = `~${currentFareDetails.distance.toFixed(1)} km, ${currentFareDetails.duration} mins`;
                dom.searchPanel.classList.add('hidden');
                dom.confirmPanel.classList.remove('hidden');
            });
        }
        
        function handleVehicleSelection(button) {
            dom.vehicleOptions.querySelectorAll('.vehicle-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
                btn.classList.add('text-slate-500');
            });
            button.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
            button.classList.remove('text-slate-500');
            selectedVehicleType = button.dataset.type;
            updateFareDisplay();
        }

        const calculateFare = (distance, vehicleType) => {
            const base = pricingSettings.baseFare;
            const perKm = pricingSettings.pricePerKm;
            let fare = base + distance * perKm;
            if(vehicleType === 'Premium') fare *= 1.5;
            if(dom.promoCodeInput.value.trim() !== '') fare *= 0.9; 
            return Math.max(2000, Math.round(fare / 100) * 100);
        }
        
        function updateFareDisplay() {
            const fare = calculateFare(currentFareDetails.distance, selectedVehicleType);
            document.getElementById('fare-display').innerText = `${fare.toLocaleString()} MMK`;
        }

        async function handleConfirmRide(isScheduled, scheduleTime = null) {
            const tripId = `trip_${Date.now()}_${currentUser.uid}`;
            // Generate Trip Token (e.g., T-1234)
            const token = `T-${Math.floor(1000 + Math.random() * 9000)}`;

            activeTrip = {
                id: tripId, 
                token: token,
                passengerId: currentUser.uid, 
                passengerPhone: passengerInfo.phone,
                pickup: pickupLocation, dropoff: dropoffLocation,
                pickupAddress: pickupLocation.address, dropoffAddress: dropoffLocation.address,
                fare: calculateFare(currentFareDetails.distance, selectedVehicleType),
                status: 'pending',
                createdAt: serverTimestamp(),
                vehicleType: selectedVehicleType,
                paymentMethod: document.getElementById('payment-method').value,
                ...(selectedDriverForBooking && { requestedDriverId: selectedDriverForBooking })
            };
            if(isScheduled) {
                activeTrip.status = 'scheduled';
                activeTrip.scheduledAt = scheduleTime;
            }

            await set(ref(db, `trips/${tripId}`), activeTrip);
            
            if (isScheduled) {
                alert(`ခရီးစဉ်မှတ်သားထားလိုက်ပါပြီ။ Token: ${token}`);
                resetToMainView();
                return;
            }
            
            dom.confirmPanel.classList.add('hidden');
            dom.directBookingAlert.classList.add('hidden');
            if (routeControl) map.removeControl(routeControl);
            if (driverRouteControl) map.removeControl(driverRouteControl);
            
            updateTripStatusUI('searching');
            dom.tripStatusPanel.classList.remove('hidden');
            listenToTripUpdates(tripId);
        }
        
        function listenToTripUpdates(tripId) {
            const tripRef = ref(db, `trips/${tripId}`);
            tripListener = onValue(tripRef, async (snapshot) => {
                if (!snapshot.exists()) {
                    if (activeTrip && activeTrip.status !== 'completed') {
                         activeTrip.status = 'completed';
                         updateTripStatusUI('completed');
                    }
                    return;
                }
                const tripData = snapshot.val();
                const previousStatus = activeTrip ? activeTrip.status : null;
                activeTrip = { ...activeTrip, ...tripData };
                
                if (tripData.status !== previousStatus) {
                     switch(tripData.status) {
                        case 'accepted':
                            tripAcceptSound.play();
                            const driverSnap = await get(ref(db, `drivers/${tripData.driverId}`));
                            activeTrip.driverDetails = driverSnap.exists() ? driverSnap.val() : { name: 'Unknown Driver' };
                            updateTripStatusUI('accepted', { driver: activeTrip.driverDetails });
                            listenToDriverLocation(tripData.driverId);
                            break;
                        case 'at_pickup': updateTripStatusUI('at_pickup'); break;
                        case 'to_dropoff': updateTripStatusUI('to_dropoff'); break;
                        case 'cancelled': alert('ခရီးစဉ် ပယ်ဖျက်လိုက်ပါသည်။'); resetToMainView(); break;
                     }
                }
            });
        }
        
        function listenToDriverLocation(driverId) {
            if (driverLocationListener) off(ref(db, `driverLocations/${driverId}`), 'value', driverLocationListener);
            const driverLocRef = ref(db, `driverLocations/${driverId}`);
            driverLocationListener = onValue(driverLocRef, (snapshot) => {
                if (!snapshot.exists() || !activeTrip) return;
                const loc = snapshot.val();
                
                // Show specific driver on map now
                if (activeDriverMarker) {
                    activeDriverMarker.setLatLng([loc.lat, loc.lng]);
                    activeDriverMarker.setIcon(driverIcon(loc.heading));
                } else {
                    activeDriverMarker = L.marker([loc.lat, loc.lng], { icon: driverIcon(loc.heading) }).addTo(map);
                }

                if (routeControl) map.removeControl(routeControl);
                if (driverRouteControl) map.removeControl(driverRouteControl);

                const isPickingUp = activeTrip.status === 'accepted';
                const isToDropoff = activeTrip.status === 'to_dropoff';

                if (isPickingUp) {
                    driverRouteControl = L.Routing.control({
                        waypoints: [ L.latLng(loc.lat, loc.lng), L.latLng(activeTrip.pickup.lat, activeTrip.pickup.lng) ],
                        createMarker: () => null, addWaypoints: false, fitSelectedRoutes: false,
                        lineOptions: { styles: [{color: '#FBBF24', opacity: 0.9, weight: 6}] }
                    }).addTo(map);
                }

                if (isPickingUp || activeTrip.status === 'at_pickup' || isToDropoff) {
                    const startPoint = isToDropoff ? L.latLng(loc.lat, loc.lng) : L.latLng(activeTrip.pickup.lat, activeTrip.pickup.lng);
                    routeControl = L.Routing.control({
                        waypoints: [ startPoint, L.latLng(activeTrip.dropoff.lat, activeTrip.dropoff.lng) ],
                        createMarker: () => null, addWaypoints: false, fitSelectedRoutes: false, 
                        lineOptions: { styles: [{color: '#3b82f6', opacity: 0.8, weight: 6}] }
                    }).addTo(map);
                }

                const bounds = L.latLngBounds([ [loc.lat, loc.lng], [activeTrip.dropoff.lat, activeTrip.dropoff.lng], [currentLocation.lat, currentLocation.lng] ]);
                map.fitBounds(bounds, { paddingTopLeft: [50, 50], paddingBottomRight: [50, 300], animate: true });
                if (driverRouteControl) {
                    driverRouteControl.on('routesfound', (e) => {
                         const etaEl = document.getElementById('driver-eta');
                         if(etaEl) etaEl.innerText = `~${Math.round(e.routes[0].summary.totalTime / 60)} မိနစ်အတွင်း ရောက်ပါမည်`;
                    });
                }
            });
        }

        function updateTripStatusUI(status, data = {}) {
            const panel = dom.tripStatusPanel;
            panel.innerHTML = '';
            
            // Show Token Header
            const tokenHeader = activeTrip && activeTrip.token ? `<div class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold w-fit mx-auto mb-2 border border-blue-200">Trip Token: ${activeTrip.token}</div>` : '';

            if (status === 'searching') {
                panel.innerHTML = `<div class="text-center p-4">
                    ${tokenHeader}
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <h3 class="text-xl font-bold text-slate-800">Driver ရှာဖွေနေပါသည်...</h3>
                    <p class="text-slate-500 mt-2">${selectedDriverForBooking ? 'သင်ရွေးချယ်ထားသော ယာဉ်မောင်းကို ဆက်သွယ်နေသည်...' : 'အနီးဆုံး ယာဉ်မောင်းကို ရှာဖွေနေပါသည်'}</p>
                    <button id="cancel-trip-button" class="w-full bg-red-50 text-red-600 border border-red-200 font-bold py-3 mt-6 rounded-xl hover:bg-red-100 transition">ခရီးစဉ် ပယ်ဖျက်မည်</button>
                </div>`;
                document.getElementById('cancel-trip-button').onclick = cancelTrip;
            } else if (status === 'accepted' || status === 'at_pickup' || status === 'to_dropoff') {
                const title = status === 'accepted' ? 'Driver ရောက်လာတော့မည်' : (status === 'at_pickup' ? 'ကားရောက်လာပါပြီ' : 'ခရီးစဉ်အတွင်း');
                panel.innerHTML = `<div class="p-2 text-center">
                    ${tokenHeader}
                    <h3 class="text-xl font-bold text-blue-600">${title}</h3>
                    ${status === 'accepted' ? '<p class="text-amber-500 font-semibold" id="driver-eta">Calculating ETA...</p>' : ''}
                    <div class="bg-slate-50 border border-slate-100 p-4 rounded-xl mt-4">
                        <p class="text-lg font-bold text-slate-800">${activeTrip.driverDetails?.name || 'Driver'}</p>
                        <p class="text-slate-500">${activeTrip.driverDetails?.carPlate || 'N/A'} - ${activeTrip.driverDetails?.carModel || 'Car'}</p>
                    </div>
                    <div class="flex justify-around mt-4 gap-4">
                         <button id="chat-driver-button" class="relative bg-blue-100 text-blue-600 font-bold py-3 px-6 rounded-xl flex-1 hover:bg-blue-200 transition">Chat</button>
                        <a href="tel:${activeTrip.driverDetails?.phone || passengerInfo.phone}" class="bg-green-100 text-green-600 font-bold py-3 px-6 rounded-xl flex-1 hover:bg-green-200 transition text-center">Call</a>
                    </div>
                </div>`;
                document.getElementById('chat-driver-button').onclick = showChatModal;
                updateChatBadge();
            } else if (status === 'completed') {
                // Show Rating Modal immediately when completed
                dom.ratingModal.classList.remove('hidden');
                currentRating = 0;
                document.querySelectorAll('.star-rating span').forEach(s => s.classList.remove('active'));
                
                panel.innerHTML = `<div class="text-center p-4">
                    ${tokenHeader}
                    <h3 class="text-2xl font-bold text-green-600">ခရီးစဉ် ပြီးဆုံးပါပြီ</h3>
                    <p class="text-lg mt-2 text-slate-700">ကျသင့်ငွေ: <span class="font-bold">${activeTrip.fare.toLocaleString()} Ks</span></p>
                    <button id="close-summary-button" class="w-full bg-blue-600 text-white font-bold py-3 mt-6 rounded-xl shadow-lg shadow-blue-500/30">ပိတ်မည်</button>
                </div>`;
                document.getElementById('close-summary-button').onclick = resetToMainView;
            }
        }
        
        async function cancelTrip() {
            if (!activeTrip || !activeTrip.id) return;
            if (confirm('ခရီးစဉ်ကို ပယ်ဖျက်ရန် သေချာပါသလား?')) await update(ref(db, `trips/${activeTrip.id}`), { status: 'cancelled' });
        }
        
        async function submitRating() {
            if(currentRating === 0) return alert('ကျေးဇူးပြု၍ အမှတ်ပေးပါ');
            if(activeTrip && activeTrip.driverId) {
                // We'll just push the rating to a list for the driver
                await push(ref(db, `drivers/${activeTrip.driverId}/ratings`), {
                    stars: currentRating,
                    tripId: activeTrip.id,
                    timestamp: serverTimestamp()
                });
                alert('အမှတ်ပေးမှုအတွက် ကျေးဇူးတင်ပါသည်!');
            }
            dom.ratingModal.classList.add('hidden');
            resetToMainView();
        }

        function showProfile() {
            dom.profileModal.classList.remove('hidden');
            document.getElementById('profile-name').innerText = passengerInfo.name;
            document.getElementById('profile-phone').innerText = passengerInfo.phone;
            document.getElementById('profile-initial').innerText = passengerInfo.name.charAt(0).toUpperCase();
            loadTripHistory();
        }
        
        async function loadTripHistory() {
            const historyContent = document.getElementById('history-content');
            historyContent.innerHTML = `<p class="text-slate-400 text-center">Loading...</p>`;
            const historyRef = query(ref(db, `passengers/${currentUser.uid}/completedTrips`), orderByChild('completedAt'));
            try {
                const snapshot = await get(historyRef);
                historyContent.innerHTML = '';
                if (snapshot.exists()) {
                    const trips = []; snapshot.forEach(c => trips.push(c.val()));
                    trips.reverse().forEach(trip => {
                         historyContent.innerHTML += `<div class="bg-slate-50 p-3 rounded-xl border border-slate-100 mb-2">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">${trip.token || 'N/A'}</span>
                                <p class="text-xs text-slate-400">${new Date(trip.completedAt).toLocaleString()}</p>
                            </div>
                            <div class="flex justify-between items-center">
                                <p class="font-bold text-slate-700 truncate max-w-[70%] text-sm">${(trip.dropoffAddress || "Unknown").split(',')[0]}</p>
                                <p class="font-bold text-green-600">${(trip.fare || 0).toLocaleString()} Ks</p>
                            </div>
                        </div>`;
                    });
                } else historyContent.innerHTML = `<p class="text-slate-400 text-center py-8">ခရီးစဉ်မှတ်တမ်း မရှိပါ။</p>`;
            } catch (e) { historyContent.innerHTML = `<p class="text-red-400 text-center py-8">Error loading history.</p>`; }
        }
        
        function saveFavorites() {
            localStorage.setItem('pyapay_home', document.getElementById('home-address-input').value);
            localStorage.setItem('pyapay_work', document.getElementById('work-address-input').value);
            alert('သိမ်းဆည်းလိုက်ပါပြီ။'); dom.profileModal.classList.add('hidden');
        }
        
        function showScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            modal.classList.remove('hidden');
            modal.innerHTML = `<div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl"><h3 class="text-xl font-bold mb-4 text-slate-800">အချိန်ရွေးပါ</h3><input id="schedule-time" type="datetime-local" class="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg mb-4 text-slate-800" /><div class="flex gap-2"><button id="cancel-schedule" class="w-1/2 bg-slate-100 text-slate-600 py-2 rounded-xl font-bold hover:bg-slate-200">Cancel</button><button id="confirm-schedule" class="w-1/2 bg-blue-600 text-white py-2 rounded-xl font-bold hover:bg-blue-700 shadow">Confirm</button></div></div>`;
            document.getElementById('cancel-schedule').onclick = () => modal.classList.add('hidden');
            document.getElementById('confirm-schedule').onclick = () => { const time = document.getElementById('schedule-time').value; if (!time) return alert('အချိန်ရွေးပေးပါ'); handleConfirmRide(true, new Date(time).getTime()); modal.classList.add('hidden'); };
        }

        function showChatModal() {
            unreadMessages = 0; updateChatBadge();
            dom.chatModal.classList.remove('hidden');
            dom.chatModal.innerHTML = `<div class="absolute inset-0 bg-black/60 z-30 flex justify-center items-end backdrop-blur-sm" id="chat-backdrop"><div class="bg-white rounded-t-2xl w-full max-w-md flex flex-col h-[85vh] shadow-2xl"><header class="flex items-center p-4 border-b border-slate-100"><button id="close-chat-button" class="p-2 -ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-500"><polyline points="15 18 9 12 15 6"></polyline></svg></button><h2 class="text-xl font-bold text-slate-800 mx-auto">Driver Chat</h2><div class="w-10"></div></header><main id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50"></main><footer class="p-4 border-t border-slate-100 bg-white"><form id="chat-form" class="flex gap-2"><input id="chat-input" type="text" placeholder="စာရိုက်ပါ..." class="flex-1 bg-slate-100 rounded-full py-2 px-4 text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500"><button type="submit" class="bg-blue-600 rounded-full p-3 text-white shadow"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button></form></footer></div></div>`;
            document.getElementById('close-chat-button').onclick = () => dom.chatModal.classList.add('hidden');
            document.getElementById('chat-backdrop').onclick = (e) => { if(e.target.id === 'chat-backdrop') dom.chatModal.classList.add('hidden'); };
            document.getElementById('chat-form').onsubmit = handleSendMessage;
            listenForChatMessages();
        }

        function listenForChatMessages() {
            const messagesRef = query(ref(db, `chats/${activeTrip.id}/messages`), orderByChild('timestamp'));
            const chatMessagesEl = document.getElementById('chat-messages');
            chatMessagesEl.innerHTML = '';
            if (chatListener) off(messagesRef, 'child_added', chatListener);
            chatListener = onChildAdded(messagesRef, (snapshot) => {
                const msg = snapshot.val();
                if(msg.sender === 'driver' && dom.chatModal.classList.contains('hidden')) {
                    unreadMessages++; updateChatBadge(); playDoubleBeep();
                }
                chatMessagesEl.innerHTML += `<div class="flex items-end gap-2 ${msg.sender === 'passenger' ? 'justify-end' : 'justify-start'}"><div class="max-w-xs px-4 py-2 rounded-2xl ${msg.sender === 'passenger' ? 'bg-blue-600 text-white rounded-br-none shadow-md' : 'bg-white text-slate-800 rounded-bl-none shadow-sm border border-slate-100'}"><p>${msg.text}</p></div></div>`;
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            });
        }
        
        function updateChatBadge() {
            const chatButton = document.getElementById('chat-driver-button');
            if (!chatButton) return;
            let badge = chatButton.querySelector('.chat-badge');
            if (unreadMessages > 0) {
                if (!badge) { badge = document.createElement('span'); badge.className = 'chat-badge'; chatButton.appendChild(badge); }
                badge.innerText = unreadMessages; badge.classList.remove('hidden');
            } else if (badge) badge.classList.add('hidden');
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text === '' || !activeTrip) return;
            await set(ref(db, `chats/${activeTrip.id}/messages/${Date.now()}`), { text, sender: 'passenger', timestamp: serverTimestamp() });
            input.value = '';
        }

        function resetToMainView(fullReset = true) {
            if (activeTrip && tripListener) off(ref(db, `trips/${activeTrip.id}`), 'value', tripListener);
            if (activeTrip && activeTrip.driverId && driverLocationListener) off(ref(db, `driverLocations/${activeTrip.driverId}`), 'value', driverLocationListener);
            if (activeTrip && chatListener) off(ref(db, `chats/${activeTrip.id}/messages`), 'child_added', chatListener);
            if (routeControl) { map.removeControl(routeControl); routeControl = null; map.setView(currentLocation, 16); }
            if (driverRouteControl) { map.removeControl(driverRouteControl); driverRouteControl = null; }
            if (activeDriverMarker) { activeDriverMarker.remove(); activeDriverMarker = null; }
            if (fullReset) { selectedDriverForBooking = null; dom.directBookingAlert.classList.add('hidden'); }
            activeTrip = null; tripListener = null; driverLocationListener = null; chatListener = null;
            pickupLocation = null; dropoffLocation = null;
            dom.destinationInput.value = ''; dom.searchResults.innerHTML = ''; dom.promoCodeInput.value = '';
            selectedVehicleType = 'Normal'; handleVehicleSelection(dom.vehicleOptions.querySelector('[data-type="Normal"]'));
            dom.tripStatusPanel.classList.add('hidden'); dom.confirmPanel.classList.add('hidden');
            dom.searchPanel.classList.remove('hidden'); dom.mainHeader.classList.remove('hidden');
            listenForNearbyDrivers();
        }

        initApp();
    </script>
</body>
</html>
