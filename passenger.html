<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pyapay Passenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        html, body { height: 100dvh; width: 100vw; margin: 0; overflow: hidden; background-color: #111827; font-family: sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; background-color: #1f2937; }
        .leaflet-control-container .leaflet-routing-container { display: none; }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .tab-active { border-color: #34d399; color: #34d399; background-color: rgba(52, 211, 153, 0.1); }
        .pulse-marker { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(52, 211, 153, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); } }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Loading -->
    <div id="loading-overlay" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center">
        <h1 class="text-3xl font-bold text-green-400 animate-pulse">Pyapay</h1>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Login -->
    <div id="login-screen" class="hidden absolute inset-0 bg-black/90 z-40 flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-5xl font-bold text-green-400 mb-2">Pyapay</h1>
            <p class="text-green-200 mb-8">Passenger App</p>
            <div class="bg-gray-800 p-6 rounded-lg space-y-4">
                <input id="passenger-name" type="text" placeholder="Name" class="w-full bg-gray-700 rounded p-3 text-white">
                <input id="passenger-phone" type="tel" placeholder="Phone" class="w-full bg-gray-700 rounded p-3 text-white">
                <button id="login-button" class="w-full bg-green-600 text-black font-bold py-3 rounded">Start</button>
            </div>
        </div>
    </div>

    <!-- Header & Recenter -->
    <div id="main-ui" class="hidden pointer-events-none absolute inset-0 z-10">
        <header class="absolute top-4 left-4 right-4 flex justify-between pointer-events-auto">
             <button id="menu-button" class="bg-gray-900/90 p-3 rounded-full shadow border border-gray-700 text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
            <button id="profile-button" class="bg-gray-900/90 p-3 rounded-full shadow border border-gray-700 text-green-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></button>
        </header>
        <button id="recenter-button" class="pointer-events-auto absolute bottom-48 right-4 bg-gray-900/90 p-3 rounded-full shadow border border-gray-700 text-green-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg></button>
    </div>

    <!-- Search Panel -->
    <div id="search-panel" class="absolute bottom-0 left-0 right-0 bg-gray-900 p-6 rounded-t-3xl shadow-2xl z-20 hidden animate-slide-up">
        <h2 class="text-xl font-bold mb-4 text-center text-green-300">Where to?</h2>
        <input id="destination-input" type="text" placeholder="Enter destination" class="w-full bg-gray-800 rounded-lg py-3 px-4 text-white focus:ring-2 focus:ring-green-500 mb-2">
        <div id="search-results" class="max-h-40 overflow-y-auto"></div>
    </div>

    <!-- Confirm Panel -->
    <div id="confirm-panel" class="absolute bottom-0 left-0 right-0 bg-gray-900 p-6 rounded-t-3xl shadow-2xl z-20 hidden animate-slide-up">
        <div class="flex justify-between items-center mb-4">
             <div><p class="text-xs text-gray-400">Est. Fare</p><h2 class="text-3xl font-bold text-white" id="fare-display">0 MMK</h2></div>
             <div class="text-right"><p class="text-lg font-bold text-green-400" id="trip-dist">0 km</p><p class="text-xs text-gray-400" id="trip-time">0 min</p></div>
        </div>
        <button id="confirm-ride-button" class="w-full bg-green-600 text-black font-bold py-4 rounded-xl">Book Now</button>
        <button onclick="resetApp()" class="w-full text-gray-500 py-3 text-sm mt-2">Cancel</button>
    </div>

    <!-- Status Panel -->
    <div id="trip-status-panel" class="absolute bottom-0 left-0 right-0 bg-gray-900 p-6 rounded-t-3xl shadow-2xl z-20 hidden animate-slide-up"></div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="hidden absolute inset-0 bg-black/90 z-50 flex items-end md:items-center justify-center">
        <div class="bg-gray-900 w-full md:w-[450px] h-[90%] md:h-[800px] rounded-t-3xl md:rounded-2xl border border-gray-700 flex flex-col">
            <div class="p-5 border-b border-gray-800 flex justify-between"><h2 class="text-xl font-bold text-green-300">Profile</h2><button onclick="document.getElementById('profile-modal').classList.add('hidden')">&times;</button></div>
            <div class="p-6 bg-gray-800/50 flex items-center gap-4"><div class="w-16 h-16 rounded-full bg-green-600 flex items-center justify-center text-2xl font-bold" id="profile-initial">U</div><div><h3 id="profile-name" class="font-bold text-lg">User</h3><p id="profile-phone" class="text-gray-400">09...</p></div></div>
            <div class="flex border-b border-gray-800"><button onclick="switchTab('history')" class="flex-1 p-4 tab-active border-b-2" id="tab-history">History</button><button onclick="switchTab('settings')" class="flex-1 p-4 border-b-2 border-transparent text-gray-400" id="tab-settings">Settings</button></div>
            <div id="history-content" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
            <div id="settings-content" class="hidden flex-1 p-4 space-y-2">
                <button class="w-full p-4 bg-gray-800 rounded flex justify-between"><span>Edit Account</span><span>&gt;</span></button>
                <button class="w-full p-4 bg-gray-800 rounded flex justify-between"><span>Language</span><span class="text-gray-400">Myanmar</span></button>
                <button onclick="handleLogout()" class="w-full p-4 bg-red-900/20 text-red-500 rounded font-bold mt-4">Log Out</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, off, remove, query, orderByChild, equalTo, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const config = { apiKey: "AIzaSyB7zSpZMYgS2SChtyFrUvvp0txPutecF3g", authDomain: "zenstride.firebaseapp.com", databaseURL: "https://zenstride-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "zenstride" };
        const app = initializeApp(config); const auth = getAuth(app); const db = getDatabase(app);
        
        let map, userMarker, routeControl, currentUser, curLoc, activeTrip;

        function initMap() {
            map = L.map('map', {zoomControl:false}).setView([16.8, 96.1], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            if(navigator.geolocation) navigator.geolocation.watchPosition(p => {
                curLoc = {lat: p.coords.latitude, lng: p.coords.longitude};
                if(!userMarker) userMarker = L.marker(curLoc, {icon: L.divIcon({html:'<div class="w-4 h-4 bg-green-500 rounded-full border-2 border-white pulse-marker"></div>', className:''})}).addTo(map);
                else userMarker.setLatLng(curLoc);
                if(!activeTrip && !routeControl) map.setView(curLoc, 15);
            });
        }
        initMap();

        onAuthStateChanged(auth, async u => {
            document.getElementById('loading-overlay').classList.add('hidden');
            if(u) {
                currentUser = u;
                const snap = await get(ref(db, `passengers/${u.uid}`));
                if(snap.exists()) {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-ui').classList.remove('hidden');
                    document.getElementById('search-panel').classList.remove('hidden');
                    document.getElementById('profile-name').innerText = snap.val().name;
                    document.getElementById('profile-phone').innerText = snap.val().phone;
                    document.getElementById('profile-initial').innerText = snap.val().name[0];
                    checkActiveTrip();
                } else document.getElementById('login-screen').classList.remove('hidden');
            } else document.getElementById('login-screen').classList.remove('hidden');
        });

        document.getElementById('login-button').onclick = async () => {
            const name = document.getElementById('passenger-name').value;
            const phone = document.getElementById('passenger-phone').value;
            if(!name) return;
            const cred = await signInAnonymously(auth);
            await set(ref(db, `passengers/${cred.user.uid}`), {name, phone});
        };

        // Recenter
        document.getElementById('recenter-button').onclick = () => { if(curLoc) map.setView(curLoc, 16); };

        // Profile
        document.getElementById('profile-button').onclick = () => {
            document.getElementById('profile-modal').classList.remove('hidden');
            loadHistory();
        };
        window.switchTab = (tab) => {
            document.getElementById('tab-history').className = tab==='history'?'flex-1 p-4 tab-active border-b-2':'flex-1 p-4 border-b-2 border-transparent text-gray-400';
            document.getElementById('tab-settings').className = tab==='settings'?'flex-1 p-4 tab-active border-b-2':'flex-1 p-4 border-b-2 border-transparent text-gray-400';
            document.getElementById('history-content').classList.toggle('hidden', tab!=='history');
            document.getElementById('settings-content').classList.toggle('hidden', tab!=='settings');
        };
        window.handleLogout = () => signOut(auth).then(()=>location.reload());

        async function loadHistory() {
            const div = document.getElementById('history-content');
            div.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';
            try {
                // Correctly fetching completedTrips subcollection
                const snap = await get(ref(db, `passengers/${currentUser.uid}/completedTrips`));
                div.innerHTML = '';
                if(snap.exists()) {
                    const trips = []; 
                    snap.forEach(c => trips.push(c.val()));
                    
                    trips.sort((a,b)=>(b.completedAt || 0) - (a.completedAt || 0)).forEach(t => {
                        div.innerHTML += `
                            <div class="bg-gray-800 p-3 rounded mb-2 border border-gray-700">
                                <div class="flex justify-between text-sm font-bold mb-1">
                                    <span class="text-gray-300">${new Date(t.completedAt).toLocaleDateString()}</span>
                                    <span class="text-green-400">${t.fare.toLocaleString()} Ks</span>
                                </div>
                                <div class="text-xs text-gray-400 truncate flex items-center gap-1">
                                    <span class="text-gray-500">To:</span> ${t.dropoffAddress}
                                </div>
                            </div>`;
                    });
                } else {
                    div.innerHTML = '<p class="text-center text-gray-500 mt-4">No trips yet.</p>';
                }
            } catch (e) {
                console.error(e);
                div.innerHTML = '<p class="text-center text-red-400 mt-4">Failed to load history.</p>';
            }
        }

        // Search & Booking Logic (Simplified for brevity)
        let searchTimeout;
        document.getElementById('destination-input').oninput = (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${e.target.value}&countrycodes=mm`);
                const data = await res.json();
                const list = document.getElementById('search-results'); list.innerHTML = '';
                data.slice(0,3).forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'p-3 border-b border-gray-700 hover:bg-gray-800 cursor-pointer text-sm';
                    item.innerText = p.display_name;
                    item.onclick = () => selectDestination(p);
                    list.appendChild(item);
                });
            }, 500);
        };

        function selectDestination(place) {
            const dest = {lat: parseFloat(place.lat), lng: parseFloat(place.lon), address: place.display_name};
            if(routeControl) map.removeControl(routeControl);
            routeControl = L.Routing.control({
                waypoints: [L.latLng(curLoc), L.latLng(dest)], createMarker:()=>null, lineOptions:{styles:[{color:'#34d399', weight:6}]}
            }).addTo(map);
            routeControl.on('routesfound', e => {
                const r = e.routes[0];
                const dist = r.summary.totalDistance/1000;
                const fare = Math.max(1500, Math.round((1500+dist*500)/100)*100);
                document.getElementById('fare-display').innerText = fare.toLocaleString() + ' MMK';
                document.getElementById('trip-dist').innerText = dist.toFixed(1) + ' km';
                document.getElementById('trip-time').innerText = Math.round(r.summary.totalTime/60) + ' min';
                document.getElementById('search-panel').classList.add('hidden');
                document.getElementById('confirm-panel').classList.remove('hidden');
                document.getElementById('confirm-ride-button').onclick = () => bookRide(dest, fare);
            });
        }

        async function bookRide(dest, fare) {
            const tripId = `trip_${Date.now()}`;
            await set(ref(db, `trips/${tripId}`), {
                id: tripId, passengerId: currentUser.uid, 
                pickup: curLoc, dropoff: dest, pickupAddress: 'Current Location', dropoffAddress: dest.address,
                fare, status: 'pending', createdAt: Date.now()
            });
            document.getElementById('confirm-panel').classList.add('hidden');
            checkActiveTrip();
        }

        function checkActiveTrip() {
            // Simplified active trip checker
            const q = query(ref(db, 'trips'), orderByChild('passengerId'), equalTo(currentUser.uid));
            onValue(q, s => {
                if(!s.exists()) { resetApp(); return; }
                const trips = Object.values(s.val());
                const trip = trips.find(t => ['pending','accepted','at_pickup','to_dropoff'].includes(t.status));
                if(trip) {
                    activeTrip = trip;
                    document.getElementById('search-panel').classList.add('hidden');
                    const panel = document.getElementById('trip-status-panel');
                    panel.classList.remove('hidden');
                    panel.innerHTML = `<h3 class="text-xl font-bold text-center text-green-400 capitalize">${trip.status.replace('_',' ')}</h3><p class="text-center text-gray-400 mt-2">${trip.status==='pending'?'Finding driver...':'Driver is on the way'}</p>`;
                } else {
                    // Check for just completed trip to show history
                    const completed = trips.find(t => t.status === 'completed' && Date.now() - (t.completedAt || 0) < 60000); // Show summary for 1 min
                    if(completed) {
                        alert(`Trip Completed! Fare: ${completed.fare}`);
                        remove(ref(db, `trips/${completed.id}`)); // Cleanup active node
                    }
                    resetApp();
                }
            });
        }

        window.resetApp = () => {
            activeTrip = null;
            if(routeControl) map.removeControl(routeControl);
            document.getElementById('confirm-panel').classList.add('hidden');
            document.getElementById('trip-status-panel').classList.add('hidden');
            document.getElementById('search-panel').classList.remove('hidden');
            document.getElementById('destination-input').value = '';
            document.getElementById('search-results').innerHTML = '';
        }
    </script>
</body>
</html>