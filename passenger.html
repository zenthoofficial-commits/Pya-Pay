
<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pyapay Passenger</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        html, body {
            overscroll-behavior-y: contain;
            height: 100dvh; width: 100vw;
            margin: 0; padding: 0;
            overflow: hidden;
            background-color: #ffffff; /* White background */
            font-family: sans-serif;
        }
        #map { height: 100%; width: 100%; z-index: 0; background-color: #e2e8f0; }
        .leaflet-bottom, .leaflet-top { z-index: 5; }
        .leaflet-control-container .leaflet-routing-container { display: none; }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-in-out forwards; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none !important; }
        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(69, 201, 255, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(69, 201, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(69, 201, 255, 0); }
        }
        .chat-badge {
            position: absolute; top: -5px; right: -8px;
            background-color: #ef4444; color: white;
            border-radius: 9999px; min-width: 20px; height: 20px;
            padding: 0 4px; font-size: 10px; display: flex;
            align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid #ffffff; z-index: 20;
        }
        #loading-overlay {
            position: fixed; inset: 0; background-color: #ffffff; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loading-spinner {
            border: 4px solid #eff6ff; border-left-color: #45C9FF; /* Theme color */
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active { border-color: #45C9FF; color: #45C9FF; }
        .star-rating span { font-size: 2rem; cursor: pointer; color: #cbd5e1; transition: color 0.2s; }
        .star-rating span.active { color: #f59e0b; }
        
        /* Map Picking Styles */
        #map-center-pin {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%); /* Tip of pin at center */
            z-index: 40; pointer-events: none;
            transition: transform 0.2s;
        }
        .map-moving #map-center-pin { transform: translate(-50%, -110%); }
        
        /* Custom Scrollbar for history */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Theme Colors */
        .bg-theme { background-color: #45C9FF; }
        .text-theme { color: #45C9FF; }
        .border-theme { border-color: #45C9FF; }
        .hover-bg-theme:hover { background-color: #3bbbf0; }
        .focus-ring-theme:focus { --tw-ring-color: #45C9FF; }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading-overlay">
        <h1 class="text-3xl font-bold text-theme mb-4 animate-pulse">Pyapay</h1>
        <div class="loading-spinner"></div>
    </div>

    <div id="map"></div>
    
    <!-- Fixed Center Pin for Selection -->
    <div id="map-center-pin" class="hidden">
        <img id="pin-image" src="" class="w-10 h-10 drop-shadow-2xl" alt="Pin">
        <div class="w-2 h-2 bg-black/30 rounded-full absolute -bottom-1 left-1/2 -translate-x-1/2 blur-[1px]"></div>
    </div>
    
    <!-- Confirm Location Button (Floating) -->
    <div id="map-confirm-container" class="hidden absolute bottom-8 left-0 right-0 z-40 px-6 flex justify-center">
        <button id="confirm-map-pick-btn" class="bg-slate-800 text-white font-bold py-3 px-8 rounded-full shadow-2xl hover:bg-slate-700 transition transform hover:scale-105 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            <span id="confirm-btn-text">ဤနေရာတွင်ထားမည်</span>
        </button>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden absolute inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 animate-fade-in">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-5xl font-bold text-theme mb-2">Pyapay</h1>
            <p class="text-slate-500 mb-8">ခရီးသည် အက်ပ် (Passenger)</p>
            <div class="bg-white border border-slate-200 shadow-xl rounded-2xl p-6 space-y-4">
                <input id="passenger-name" type="text" placeholder="သင့်အမည်" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus-ring-theme">
                <input id="passenger-phone" type="tel" placeholder="ဖုန်းနံပါတ်" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus-ring-theme">
                <button id="login-button" class="w-full bg-theme text-white font-bold py-3 rounded-xl hover-bg-theme transition shadow-lg shadow-blue-200">စတင်အသုံးပြုမည်</button>
            </div>
        </div>
    </div>
    
    <!-- Main UI Container -->
    <div id="main-ui" class="hidden">
        <!-- Header -->
        <header id="main-header" class="absolute top-4 left-4 right-4 z-10 flex justify-between items-center pointer-events-none">
             <button id="menu-button" class="pointer-events-auto bg-white p-3 rounded-full shadow-lg border border-slate-200 hover:bg-slate-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <button id="profile-button" class="pointer-events-auto bg-white p-3 rounded-full shadow-lg border border-slate-200 hover:bg-slate-50">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-600"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </button>
        </header>

        <!-- Recenter Button -->
        <button id="recenter-btn" class="absolute bottom-72 right-4 z-20 bg-white text-theme p-3 rounded-full shadow-lg border border-slate-200 hover:bg-slate-50 transition">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>
        </button>

        <!-- Nearby Drivers Panel (Left Menu) -->
        <div id="nearby-drivers-panel" class="hidden absolute top-0 left-0 bottom-0 w-full md:w-80 bg-white p-4 z-20 animate-fade-in border-r border-slate-200 shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-4 flex-shrink-0">
                <h2 class="text-xl font-bold text-slate-800">အနီးအနားရှိ ယာဉ်မောင်းများ</h2>
                 <button id="close-drivers-panel" class="p-1 rounded-full hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div id="drivers-list" class="flex-1 overflow-y-auto space-y-4 pr-1 pb-4">
                <p class="text-slate-400 text-center py-8">ယာဉ်မောင်းများ ရှာဖွေနေသည်...</p>
            </div>
        </div>

        <!-- Panels -->
        <div id="search-panel" class="absolute bottom-0 left-0 right-0 bg-white p-4 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] animate-slide-up z-10">
            <h2 class="text-xl font-bold mb-3 text-center text-slate-800">ခရီးစဉ် စတင်ပါ</h2>
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 space-y-3 relative">
                <!-- Pickup Input -->
                <div class="relative">
                    <div class="absolute left-3 top-3 w-3 h-3 bg-theme rounded-full border border-white shadow-sm"></div>
                    <input id="pickup-input" type="text" placeholder="လက်ရှိနေရာ" class="w-full bg-white border border-slate-200 rounded-lg py-3 pl-8 pr-12 text-slate-800 text-sm focus:outline-none focus:ring-2 focus-ring-theme">
                    <button class="map-pick-btn absolute right-2 top-2 p-1.5 bg-blue-50 rounded hover:bg-blue-100 text-theme" data-target="pickup">
                        <!-- Blue GPS Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    </button>
                </div>

                <!-- Connector Line -->
                <div class="absolute left-[1.65rem] top-[3.2rem] w-0.5 h-6 bg-slate-300 z-0"></div>

                <!-- Dropoff Input -->
                <div class="relative z-10">
                    <div class="absolute left-3 top-3 w-3 h-3 bg-red-500 rounded-sm border border-white shadow-sm"></div>
                    <input id="dropoff-input" type="text" placeholder="သွားလိုသောနေရာ ရှာပါ" class="w-full bg-white border border-slate-200 rounded-lg py-3 pl-8 pr-12 text-slate-800 text-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                     <button class="map-pick-btn absolute right-2 top-2 p-1.5 bg-red-50 rounded hover:bg-red-100 text-red-500" data-target="dropoff">
                        <!-- Red Pin Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    </button>
                </div>
                
                <div id="search-results" class="mt-2 max-h-40 overflow-y-auto hidden bg-white border border-slate-200 rounded-lg shadow-lg"></div>
            </div>
        </div>

        <div id="confirm-panel" class="hidden absolute bottom-0 left-0 right-0 bg-white p-4 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] animate-slide-up z-10">
            <div id="direct-booking-alert" class="hidden bg-amber-50 border border-amber-200 text-amber-700 p-2 rounded-lg text-center text-sm mb-3">
                <span class="font-bold">တိုက်ရိုက်ငှားရမ်းခြင်း:</span> ရွေးချယ်ထားသော ယာဉ်မောင်းထံ ဦးစားပေးပို့ပါမည်။
            </div>
            <div id="vehicle-options" class="flex justify-around mb-4 bg-slate-100 p-1 rounded-full">
                <button data-type="Normal" class="vehicle-btn flex-1 py-2 px-4 rounded-full text-center font-semibold bg-white text-slate-800 shadow-sm">Normal</button>
                <button data-type="Premium" class="vehicle-btn flex-1 py-2 px-4 rounded-full text-center font-semibold text-slate-500">Premium</button>
            </div>
            <div class="text-center mb-3">
                <h2 class="text-2xl font-bold text-slate-800" id="fare-display"></h2>
                <p class="text-slate-500" id="trip-info-display"></p>
            </div>
            <div class="flex gap-2 mb-4">
                <select id="payment-method" class="w-1/2 bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm text-slate-800 focus:outline-none focus:ring-1 focus-ring-theme">
                    <option value="Cash">ငွေသား (Cash)</option>
                    <option value="KBZPay">KBZPay</option>
                    <option value="WavePay">WavePay</option>
                </select>
                <input id="promo-code" type="text" placeholder="ပရိုမိုကုဒ်" class="w-1/2 bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm text-slate-800 focus:outline-none focus:ring-1 focus-ring-theme">
            </div>
            
            <button id="confirm-ride-button" class="w-full bg-theme text-white font-bold py-3 rounded-xl hover-bg-theme transition shadow-lg shadow-blue-200">ချက်ချင်းခေါ်မည်</button>
            
            <button id="cancel-search-button" class="w-full bg-transparent text-slate-400 font-semibold py-2 mt-2 rounded-lg hover:text-slate-600 transition">ပယ်ဖျက်မည်</button>
        </div>

        <div id="trip-status-panel" class="hidden absolute bottom-0 left-0 right-0 bg-white p-4 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] animate-slide-up z-10"></div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profile-modal" class="hidden absolute inset-0 bg-black/60 z-40 animate-fade-in flex justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md h-full max-h-[95vh] rounded-2xl shadow-2xl flex flex-col">
            <header class="p-4 flex justify-between items-center border-b border-slate-100">
                <h2 class="text-xl font-bold text-slate-800">အကောင့် (Profile)</h2>
                <button id="close-profile-button" class="p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </header>
            <div class="p-4 flex items-center gap-4 border-b border-slate-100 bg-slate-50">
                <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-2xl font-bold text-theme" id="profile-initial"></div>
                <div>
                    <h3 id="profile-name" class="text-lg font-bold text-slate-800"></h3>
                    <p id="profile-phone" class="text-sm text-slate-500"></p>
                </div>
            </div>
            <div class="flex border-b border-slate-100">
                <button data-tab="history" class="profile-tab flex-1 p-3 font-semibold border-b-2 tab-active transition-colors">မှတ်တမ်း</button>
                <button data-tab="favorites" class="profile-tab flex-1 p-3 font-semibold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors">အကြိုက်ဆုံး</button>
                <button data-tab="settings" class="profile-tab flex-1 p-3 font-semibold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-colors">ဆက်တင်များ</button>
            </div>
            <div id="history-content" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar"></div>
            <div id="favorites-content" class="hidden flex-1 overflow-y-auto p-4 space-y-4">
                <div>
                    <label class="text-sm text-slate-500 font-bold">အိမ်</label>
                    <input id="home-address-input" type="text" placeholder="လိပ်စာ" class="w-full mt-1 bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm text-slate-800">
                </div>
                 <div>
                    <label class="text-sm text-slate-500 font-bold">အလုပ်</label>
                    <input id="work-address-input" type="text" placeholder="လိပ်စာ" class="w-full mt-1 bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm text-slate-800">
                </div>
                <button id="save-favorites-button" class="w-full bg-theme text-white font-bold py-2 mt-2 rounded-lg shadow">သိမ်းဆည်းမည်</button>
            </div>
            <div id="settings-content" class="hidden flex-1 overflow-y-auto p-4 space-y-4">
                 <button id="logout-button" class="w-full bg-red-50 text-red-600 font-bold py-3 mt-6 rounded-lg border border-red-100 hover:bg-red-100">အကောင့်ထွက်မည်</button>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="rating-modal" class="hidden absolute inset-0 bg-black/70 z-50 flex justify-center items-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 text-center shadow-2xl">
            <h3 class="text-xl font-bold text-slate-800 mb-2">ခရီးစဉ် ပြီးဆုံးပါပြီ</h3>
            <p class="text-slate-500 mb-6">ယာဉ်မောင်းအား အမှတ်ပေးပါ</p>
            <div class="star-rating flex justify-center gap-2 mb-6" id="star-rating">
                <span data-val="1">★</span><span data-val="2">★</span><span data-val="3">★</span><span data-val="4">★</span><span data-val="5">★</span>
            </div>
            <button id="submit-rating-btn" class="w-full bg-theme text-white font-bold py-3 rounded-xl shadow-lg hover-bg-theme">အမှတ်ပေးမည်</button>
            <button id="skip-rating-btn" class="mt-3 text-slate-400 hover:text-slate-600 font-semibold text-sm">ကျော်သွားမည်</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="chat-modal" class="hidden"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, off, remove, query, orderByChild, equalTo, onChildAdded, serverTimestamp, update, limitToLast, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Separate App Name to avoid conflict with Admin Panel if run in same browser
        const firebaseConfig = { apiKey: "AIzaSyB7zSpZMYgS2SChtyFrUvvp0txPutecF3g", authDomain: "zenstride.firebaseapp.com", databaseURL: "https://zenstride-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "zenstride", storageBucket: "zenstride.firebasestorage.app", messagingSenderId: "588697035765", appId: "1:588697035765:web:9411ea5aa9588ceb7d36bc" };
        const app = initializeApp(firebaseConfig, "passengerApp"); 
        const auth = getAuth(app);
        const db = getDatabase(app);

        let map, userMarker, routeControl, driverRouteControl;
        let activeDriverMarker = null;
        let currentUser = null, passengerInfo = null, currentLocation = null, activeTrip = null;
        let pickupLocation = null, dropoffLocation = null;
        let tripListener = null, driverLocationListener = null, chatListener = null, nearbyDriversListener = null;
        let currentFareDetails = { distance: 0, duration: 0, baseFare: 0 };
        let selectedVehicleType = 'Normal';
        let selectedDriverForBooking = null;
        let unreadMessages = 0;
        let driversListLastUpdate = 0;
        let pricingSettings = { baseFare: 1500, pricePerKm: 500 };
        let currentRating = 0;
        
        // Driver Queue Logic
        let driverQueue = [];
        let tripMonitorInterval = null;
        
        // Map Selection Mode
        let isPickingOnMap = false;
        let pickingTarget = null; // 'pickup' or 'dropoff'
        
        // SVG Icons for Pin
        const BLUE_PIN_SVG = `data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="#45C9FF" stroke="white" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3" fill="white"></circle></svg>')}`;
        const RED_PIN_SVG = `data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="#ef4444" stroke="white" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3" fill="white"></circle></svg>')}`;

        const dom = {
            loadingOverlay: document.getElementById('loading-overlay'),
            loginScreen: document.getElementById('login-screen'),
            mainUI: document.getElementById('main-ui'),
            mainHeader: document.getElementById('main-header'),
            searchPanel: document.getElementById('search-panel'),
            confirmPanel: document.getElementById('confirm-panel'),
            tripStatusPanel: document.getElementById('trip-status-panel'),
            profileModal: document.getElementById('profile-modal'),
            chatModal: document.getElementById('chat-modal'),
            pickupInput: document.getElementById('pickup-input'),
            dropoffInput: document.getElementById('dropoff-input'),
            searchResults: document.getElementById('search-results'),
            vehicleOptions: document.getElementById('vehicle-options'),
            promoCodeInput: document.getElementById('promo-code'),
            nearbyDriversPanel: document.getElementById('nearby-drivers-panel'),
            driversList: document.getElementById('drivers-list'),
            directBookingAlert: document.getElementById('direct-booking-alert'),
            recenterBtn: document.getElementById('recenter-btn'),
            ratingModal: document.getElementById('rating-modal'),
            // Fixed Pin Elements
            mapCenterPin: document.getElementById('map-center-pin'),
            pinImage: document.getElementById('pin-image'),
            mapConfirmContainer: document.getElementById('map-confirm-container'),
            confirmMapPickBtn: document.getElementById('confirm-map-pick-btn'),
            confirmBtnText: document.getElementById('confirm-btn-text')
        };
        
        const userIcon = L.divIcon({ html: `<div class="w-6 h-6 bg-theme rounded-full border-2 border-white pulse shadow-lg"></div>`, className: '', iconSize: [24, 24], iconAnchor: [12, 12] });
        const driverIcon = (rotation) => L.divIcon({ html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#16a34a" class="w-8 h-8 drop-shadow-md" style="transform: rotate(${rotation || 0}deg);"><path d="M19,5.5C19,4.4,18.1,3.5,17,3.5H7C5.9,3.5,5,4.4,5,5.5V16.5C5,17.6,5.9,18.5,7,18.5H6C5.4,18.5,5,18.9,5,19.5S5.4,20.5,6,20.5H18C18.6,20.5,19,20.1,19,19.5S18.6,18.5,18,18.5H17C18.1,18.5,19,17.6,19,16.5V5.5M17,16.5H7V5.5H17V16.5M8,15.5A1.5,1.5 0 0,0 9.5,17A1.5,1.5 0 0,0 11,15.5A1.5,1.5 0 0,0 9.5,14A1.5,1.5 0 0,0 8,15.5M13,15.5A1.5,1.5 0 0,0 14.5,17A1.5,1.5 0 0,0 16,15.5A1.5,1.5 0 0,0 14.5,14A1.5,1.5 0 0,0 13,15.5M7,8.5H17V11.5H7V8.5Z" /></svg>`, className: '', iconSize: [32, 32], iconAnchor: [16, 16] });
        
        const pickupIcon = L.divIcon({ html: `<img src="${BLUE_PIN_SVG}" class="w-8 h-8">`, className: '', iconSize: [32, 32], iconAnchor: [16, 32] });
        const dropoffIcon = L.divIcon({ html: `<img src="${RED_PIN_SVG}" class="w-8 h-8">`, className: '', iconSize: [32, 32], iconAnchor: [16, 32] });


        // Sounds
        const messageSound = new Audio("data:audio/wav;base64,UklGRlFFT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUFENQDI7PAA8gDwAPUA9ADzAPIBAAIEAwQDBAIBAAAAAP8A/gD4APUA8gDxAPIA8gDzAO8A7ADoAN4A2gDYANoA3gDkAO0A9AEAAv9//wD+APwA+gD7AP0AAQIDBAUGBwgJCgsMDQ4PDxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w==");
        const tripAcceptSound = new Audio("data:audio/wav;base64,UklGRlFFT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUFENQDI7PAA8gDwAPUA9ADzAPIBAAIEAwQDBAIBAAAAAP8A/gD4APUA8gDxAPIA8gDzAO8A7ADoAN4A2gDYANoA3gDkAO0A9AEAAv9//wD+APwA+gD7AP0AAQIDBAUGBwgJCgsMDQ4PDxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w==");
        
        function playDoubleBeep() {
            messageSound.currentTime = 0; messageSound.play().catch(e=>console.log(e));
            setTimeout(() => { messageSound.currentTime = 0; messageSound.play().catch(e=>console.log(e)); }, 200);
        }
        
        function showNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/3063/3063823.png' });
            }
        }

        function initApp() {
            initMap();
            setupAuthListener();
            setupEventListeners();
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([16.8409, 96.1735], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            navigator.geolocation.watchPosition(pos => {
                currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                if (!pickupLocation) {
                    pickupLocation = { lat: currentLocation.lat, lng: currentLocation.lng, address: "လက်ရှိနေရာ" };
                }
                if (!map.getBounds().contains(L.latLng(currentLocation))) map.setView(currentLocation, 16);
                if (!userMarker) userMarker = L.marker(currentLocation, { icon: userIcon }).addTo(map);
                else userMarker.setLatLng(currentLocation);
            }, console.warn, { enableHighAccuracy: true });
            
            // Map Drag Event for Pin Animation
            map.on('dragstart', () => document.body.classList.add('map-moving'));
            map.on('dragend', () => document.body.classList.remove('map-moving'));
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async user => {
                dom.loadingOverlay.classList.remove('hidden');
                if (user) {
                    currentUser = user;
                    const snapshot = await get(ref(db, `passengers/${user.uid}`));
                    if (snapshot.exists()) {
                        passengerInfo = snapshot.val();
                        dom.loginScreen.classList.add('hidden');
                        dom.mainUI.classList.remove('hidden');
                        fetchSettings();
                        await checkForActiveTrip(user.uid);
                    } else {
                        dom.loginScreen.classList.remove('hidden');
                        dom.mainUI.classList.add('hidden');
                    }
                } else {
                    dom.loginScreen.classList.remove('hidden');
                    dom.mainUI.classList.add('hidden');
                    if (nearbyDriversListener) off(ref(db, `driverLocations`), 'value', nearbyDriversListener);
                }
                setTimeout(() => dom.loadingOverlay.classList.add('hidden'), 500);
            });
        }
        
        async function fetchSettings() {
             const snap = await get(ref(db, 'settings/fees'));
             if(snap.exists()) {
                 const data = snap.val();
                 pricingSettings = { baseFare: data.baseFare || 1500, pricePerKm: data.pricePerKm || 500 };
             }
        }
        
        async function checkForActiveTrip(uid) {
            const activeTripsQuery = query(ref(db, 'trips'), orderByChild('passengerId'), equalTo(uid), limitToLast(1));
            const snapshot = await get(activeTripsQuery);
            if (snapshot.exists()) {
                const trips = snapshot.val();
                const tripId = Object.keys(trips)[0];
                const tripData = trips[tripId];
                if (['accepted', 'at_pickup', 'to_dropoff', 'pending'].includes(tripData.status)) {
                    activeTrip = { id: tripId, ...tripData };
                    dom.searchPanel.classList.add('hidden');
                    dom.confirmPanel.classList.add('hidden');
                    dom.tripStatusPanel.classList.remove('hidden');
                    if(tripData.status === 'pending') updateTripStatusUI('searching');
                    else listenToTripUpdates(tripId);
                    return;
                }
            }
            startAppFlow();
        }

        function setupEventListeners() {
            document.getElementById('login-button').addEventListener('click', handleLogin);
            document.getElementById('profile-button').addEventListener('click', showProfile);
            document.getElementById('close-profile-button').addEventListener('click', () => dom.profileModal.classList.add('hidden'));
            document.getElementById('menu-button').addEventListener('click', () => {
                dom.nearbyDriversPanel.classList.remove('hidden');
                refreshDriversList();
            });
            document.getElementById('close-drivers-panel').addEventListener('click', () => dom.nearbyDriversPanel.classList.add('hidden'));
            
            // Search Inputs
            dom.pickupInput.addEventListener('input', (e) => handleAddressSearch(e, 'pickup'));
            dom.dropoffInput.addEventListener('input', (e) => handleAddressSearch(e, 'dropoff'));

            // Map Picking Buttons
            document.querySelectorAll('.map-pick-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.currentTarget.dataset.target; // pickup or dropoff
                    startMapPicking(target);
                });
            });
            
            // Confirm Pick Btn
            dom.confirmMapPickBtn.addEventListener('click', handleConfirmPick);

            document.getElementById('confirm-ride-button').addEventListener('click', () => handleConfirmRide());
            document.getElementById('cancel-search-button').addEventListener('click', resetToMainView);
            dom.vehicleOptions.addEventListener('click', (e) => {
                if(e.target.matches('.vehicle-btn')) handleVehicleSelection(e.target);
            });
            dom.promoCodeInput.addEventListener('input', updateFareDisplay);
            document.querySelectorAll('.profile-tab').forEach(tab => tab.addEventListener('click', handleTabSwitch));
            document.getElementById('save-favorites-button').addEventListener('click', saveFavorites);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            dom.recenterBtn.addEventListener('click', () => {
                if (currentLocation && map) map.setView(currentLocation, 17);
            });
            
            // Rating
            document.querySelectorAll('.star-rating span').forEach(star => {
                star.onclick = (e) => {
                    const val = parseInt(e.target.dataset.val);
                    currentRating = val;
                    document.querySelectorAll('.star-rating span').forEach(s => {
                         s.classList.toggle('active', parseInt(s.dataset.val) <= val);
                    });
                }
            });
            document.getElementById('submit-rating-btn').onclick = submitRating;
            document.getElementById('skip-rating-btn').onclick = () => { dom.ratingModal.classList.add('hidden'); resetToMainView(); };
        }

        function handleLogout() { signOut(auth).then(() => window.location.reload()); }
        
        function handleTabSwitch(e) {
            const tabName = e.currentTarget.dataset.tab;
            document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('tab-active'));
            e.currentTarget.classList.add('tab-active');
            ['history-content', 'favorites-content', 'settings-content'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
        }

        async function handleLogin() {
            const name = document.getElementById('passenger-name').value;
            const phone = document.getElementById('passenger-phone').value;
            if (!name || !phone) return alert('အမည်နှင့် ဖုန်းနံပါတ် ဖြည့်စွက်ပေးပါ။');
            
            // Request Notification Permission
            if (Notification.permission !== "granted") {
                await Notification.requestPermission();
            }

            try {
                const userCredential = await signInAnonymously(auth);
                passengerInfo = { name, phone };
                // IMPORTANT: Use UPDATE instead of SET to avoid wiping out child nodes (completedTrips)
                await update(ref(db, `passengers/${userCredential.user.uid}`), passengerInfo);
            } catch (e) {
                alert("Login Error: " + e.message);
            }
        }
        
        function startMapPicking(target) {
            isPickingOnMap = true;
            pickingTarget = target;
            
            // Hide Search Panel, Show Fixed Pin and Button
            dom.searchPanel.classList.add('hidden');
            dom.recenterBtn.classList.add('hidden');
            dom.mapCenterPin.classList.remove('hidden');
            dom.mapConfirmContainer.classList.remove('hidden');
            
            // Set Pin Color based on target
            if(target === 'pickup') {
                dom.pinImage.src = BLUE_PIN_SVG;
                dom.confirmBtnText.innerText = "ဤနေရာတွင် လာကြိုပါ";
                dom.confirmMapPickBtn.className = dom.confirmMapPickBtn.className.replace('bg-red-600', 'bg-theme').replace('hover:bg-red-700', 'hover-bg-theme');
            } else {
                dom.pinImage.src = RED_PIN_SVG;
                dom.confirmBtnText.innerText = "ဤနေရာသို့ သွားမည်";
                dom.confirmMapPickBtn.className = dom.confirmMapPickBtn.className.replace('bg-theme', 'bg-red-600').replace('hover-bg-theme', 'hover:bg-red-700');
            }
        }
        
        async function handleConfirmPick() {
            dom.confirmBtnText.innerText = "လိပ်စာရယူနေသည်...";
            const center = map.getCenter();
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}`);
                const data = await response.json();
                const address = data.display_name;
                const loc = { lat: center.lat, lng: center.lng, address };
                
                if (pickingTarget === 'pickup') {
                    pickupLocation = loc;
                    dom.pickupInput.value = address.split(',')[0];
                } else {
                    dropoffLocation = loc;
                    dom.dropoffInput.value = address.split(',')[0];
                }
                
                // Reset UI
                isPickingOnMap = false;
                pickingTarget = null;
                dom.mapCenterPin.classList.add('hidden');
                dom.mapConfirmContainer.classList.add('hidden');
                dom.searchPanel.classList.remove('hidden');
                dom.recenterBtn.classList.remove('hidden');
                
                if (pickupLocation && dropoffLocation) {
                    calcRoute();
                }

            } catch (err) {
                alert("လိပ်စာရယူမရနိုင်ပါ။ အင်တာနက်စစ်ဆေးပါ။");
                dom.confirmBtnText.innerText = "အတည်ပြုမည်";
            }
        }

        function startAppFlow() { 
            resetToMainView();
            listenForNearbyDrivers();
        }

        function listenForNearbyDrivers() {
            const driversRef = ref(db, `driverLocations`);
            if (nearbyDriversListener) off(driversRef, 'value', nearbyDriversListener);

            nearbyDriversListener = onValue(driversRef, (snapshot) => {
                const driversData = snapshot.val() || {};
                if(!dom.nearbyDriversPanel.classList.contains('hidden')) {
                    const now = Date.now();
                    if (now - driversListLastUpdate > 2000) { 
                         refreshDriversList(driversData);
                         driversListLastUpdate = now;
                    }
                }
            });
        }

        async function refreshDriversList(cachedLocations = null) {
            let locations = cachedLocations;
            if (!locations) {
                const snap = await get(ref(db, 'driverLocations'));
                locations = snap.val() || {};
            }

            const driverPromises = Object.entries(locations).map(async ([driverId, loc]) => {
                if (!currentLocation) return null;
                const distMeters = L.latLng(currentLocation).distanceTo([loc.lat, loc.lng]);
                const distKm = (distMeters / 1000).toFixed(1);
                const duration = Math.ceil(distKm * 2); 
                const profileSnap = await get(ref(db, `drivers/${driverId}`));
                const profile = profileSnap.val() || { name: 'Unknown', carModel: 'Car', carPlate: 'N/A' };
                const estPrice = Math.max(2000, Math.round((pricingSettings.baseFare + parseFloat(distKm) * pricingSettings.pricePerKm)/100)*100);
                return { id: driverId, ...loc, ...profile, distKm, duration, price: estPrice };
            });

            const drivers = (await Promise.all(driverPromises)).filter(d => d !== null);
            drivers.sort((a, b) => parseFloat(a.distKm) - parseFloat(b.distKm));

            dom.driversList.innerHTML = '';
            
            if (drivers.length === 0) {
                 dom.driversList.innerHTML = `<p class="text-slate-400 text-center py-8">အနီးအနားတွင် ယာဉ်မောင်းမရှိပါ။</p>`;
            } else {
                 drivers.forEach(d => {
                    const statusColor = d.isAvailable ? 'text-green-500' : 'text-red-500';
                    const statusText = d.isAvailable ? 'အားသည်' : 'မအားပါ';
                    const opacity = d.isAvailable ? 'opacity-100' : 'opacity-60';
                    const cursor = d.isAvailable ? 'cursor-pointer hover:bg-slate-50' : 'cursor-not-allowed';

                    const card = document.createElement('div');
                    card.className = `bg-white p-3 rounded-xl border border-slate-200 ${cursor} ${opacity} transition-colors shadow-sm`;
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                 <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center border border-slate-200 overflow-hidden">
                                     ${d.profilePic ? `<img src="${d.profilePic}" class="w-full h-full object-cover">` : 
                                    `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`}
                                 </div>
                                 <div>
                                    <h3 class="font-bold text-slate-800">${d.name}</h3>
                                    <p class="text-xs text-slate-500">${d.carModel} • <span class="text-theme font-mono font-bold">${d.carPlate}</span></p>
                                 </div>
                            </div>
                            <span class="text-xs font-bold ${statusColor}">${statusText}</span>
                        </div>
                        <div class="mt-3 flex justify-between items-center text-sm border-t border-slate-100 pt-2">
                            <div class="flex gap-4">
                                <div><p class="text-slate-400 text-xs">အကွာအဝေး</p><p class="font-semibold text-slate-700">${d.distKm} km</p></div>
                                <div><p class="text-slate-400 text-xs">ခန့်မှန်းခ</p><p class="font-bold text-green-600">~${d.price.toLocaleString()} Ks</p></div>
                            </div>
                            ${d.isAvailable ? `<button class="select-driver-btn bg-theme text-white text-xs font-bold py-1 px-3 rounded hover-bg-theme shadow">ရွေးချယ်မည်</button>` : ''}
                        </div>
                    `;
                    if (d.isAvailable) {
                        card.querySelector('.select-driver-btn').onclick = (e) => {
                            e.stopPropagation();
                            selectedDriverForBooking = d.id;
                            dom.nearbyDriversPanel.classList.add('hidden');
                            dom.directBookingAlert.classList.remove('hidden');
                            alert(`${d.name} ကို ရွေးချယ်လိုက်ပါပြီ။ ခရီးစဉ်စတင်ရန် သွားလိုသောနေရာကို ရှာဖွေပါ။`);
                            dom.dropoffInput.focus();
                        };
                    }
                    dom.driversList.appendChild(card);
                });
            }
        }

        let searchTimeout;
        function handleAddressSearch(e, target) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const query = e.target.value;
                if (query.length < 3) {
                     dom.searchResults.classList.add('hidden');
                     return;
                }
                dom.searchResults.classList.remove('hidden');
                dom.searchResults.innerHTML = `<p class="text-slate-400 p-2 text-center text-xs">ရှာဖွေနေသည်...</p>`;
                try {
                    // Prioritize Mandalay Area (Viewbox approx)
                    const viewbox = "95.8,22.1,96.3,21.7"; // Rough box around Mandalay
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=mm&addressdetails=1&viewbox=${viewbox}&bounded=0`);
                    const results = await response.json();
                    
                    dom.searchResults.innerHTML = '';
                    if (results.length > 0) {
                        results.slice(0, 5).forEach(place => {
                            const resultDiv = document.createElement('div');
                            resultDiv.className = 'p-3 border-b border-slate-100 cursor-pointer hover:bg-slate-50 text-slate-700 text-sm';
                            resultDiv.innerText = place.display_name;
                            resultDiv.onclick = () => selectLocation(place, target);
                            dom.searchResults.appendChild(resultDiv);
                        });
                    } else dom.searchResults.innerHTML = `<p class="text-slate-400 p-2 text-center text-xs">ရလဒ်မရှိပါ</p>`;
                } catch(e) { dom.searchResults.innerHTML = `<p class="text-red-400 p-2 text-center text-xs">Error.</p>`; }
            }, 500);
        }

        function selectLocation(place, target) {
            const loc = { lat: parseFloat(place.lat), lng: parseFloat(place.lon), address: place.display_name };
            if (target === 'pickup') {
                pickupLocation = loc;
                dom.pickupInput.value = place.display_name.split(',')[0];
            } else {
                dropoffLocation = loc;
                dom.dropoffInput.value = place.display_name.split(',')[0];
            }
            dom.searchResults.classList.add('hidden');
            
            if (pickupLocation && dropoffLocation) {
                calcRoute();
            }
        }
        
        function calcRoute() {
            if (routeControl) map.removeControl(routeControl);
            
            // Use Custom Icons for Route markers
            const plan = L.Routing.plan([ L.latLng(pickupLocation.lat, pickupLocation.lng), L.latLng(dropoffLocation.lat, dropoffLocation.lng) ], {
                createMarker: function(i, wp) {
                    return L.marker(wp.latLng, {
                        draggable: false,
                        icon: i === 0 ? pickupIcon : dropoffIcon
                    });
                }
            });

            routeControl = L.Routing.control({
                plan: plan,
                lineOptions: { styles: [{color: '#45C9FF', opacity: 0.8, weight: 6}] },
                addWaypoints: false, draggableWaypoints: false
            }).addTo(map);

            routeControl.on('routesfound', function(e) {
                const route = e.routes[0];
                currentFareDetails.distance = route.summary.totalDistance / 1000;
                currentFareDetails.duration = Math.round(route.summary.totalTime / 60);
                updateFareDisplay();
                document.getElementById('trip-info-display').innerText = `~${currentFareDetails.distance.toFixed(1)} km, ${currentFareDetails.duration} မိနစ်`;
                dom.searchPanel.classList.add('hidden');
                dom.confirmPanel.classList.remove('hidden');
            });
        }
        
        function handleVehicleSelection(button) {
            dom.vehicleOptions.querySelectorAll('.vehicle-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
                btn.classList.add('text-slate-500');
            });
            button.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
            button.classList.remove('text-slate-500');
            selectedVehicleType = button.dataset.type;
            updateFareDisplay();
        }

        const calculateFare = (distance, vehicleType) => {
            const base = pricingSettings.baseFare;
            const perKm = pricingSettings.pricePerKm;
            let fare = base + distance * perKm;
            if(vehicleType === 'Premium') fare *= 1.5;
            if(dom.promoCodeInput.value.trim() !== '') fare *= 0.9; 
            return Math.max(2000, Math.round(fare / 100) * 100);
        }
        
        function updateFareDisplay() {
            const fare = calculateFare(currentFareDetails.distance, selectedVehicleType);
            document.getElementById('fare-display').innerText = `${fare.toLocaleString()} MMK`;
        }
        
        // Find Nearest Drivers Function
        async function findNearestDrivers() {
            const snapshot = await get(ref(db, 'driverLocations'));
            if (!snapshot.exists()) return [];
            
            const drivers = [];
            snapshot.forEach(child => {
                const d = child.val();
                if (d.isAvailable) {
                    const dist = L.latLng(pickupLocation).distanceTo([d.lat, d.lng]);
                    drivers.push({ id: child.key, dist });
                }
            });
            // Sort by distance
            drivers.sort((a, b) => a.dist - b.dist);
            return drivers.map(d => d.id);
        }

        async function handleConfirmRide() {
            let initialDriver = selectedDriverForBooking;
            let queue = [];
            
            // If not direct booking, find nearest drivers
            if (!initialDriver) {
                queue = await findNearestDrivers();
                if (queue.length > 0) {
                    initialDriver = queue[0];
                }
            }

            const tripId = `trip_${Date.now()}_${currentUser.uid}`;
            const token = `T-${Math.floor(1000 + Math.random() * 9000)}`;

            activeTrip = {
                id: tripId, 
                token: token,
                passengerId: currentUser.uid, 
                passengerPhone: passengerInfo.phone,
                pickup: pickupLocation, dropoff: dropoffLocation,
                pickupAddress: pickupLocation.address, dropoffAddress: dropoffLocation.address,
                fare: calculateFare(currentFareDetails.distance, selectedVehicleType),
                status: 'pending',
                createdAt: serverTimestamp(),
                vehicleType: selectedVehicleType,
                paymentMethod: document.getElementById('payment-method').value,
                requestTime: Date.now(),
                requestedDriverId: initialDriver || null,
                driverQueue: queue, // Store the queue
                declinedDriverIds: []
            };

            await set(ref(db, `trips/${tripId}`), activeTrip);
            
            dom.confirmPanel.classList.add('hidden');
            dom.directBookingAlert.classList.add('hidden');
            if (routeControl) map.removeControl(routeControl);
            if (driverRouteControl) map.removeControl(driverRouteControl);
            
            updateTripStatusUI('searching');
            dom.tripStatusPanel.classList.remove('hidden');
            listenToTripUpdates(tripId);
            
            // Start Monitor for Timeout/Decline
            monitorTripStatus(tripId);
        }
        
        function monitorTripStatus(tripId) {
            if (tripMonitorInterval) clearInterval(tripMonitorInterval);
            
            tripMonitorInterval = setInterval(async () => {
                if (!activeTrip || activeTrip.id !== tripId || activeTrip.status !== 'pending') {
                    clearInterval(tripMonitorInterval);
                    return;
                }

                // Check for Timeout (2 minutes) OR if driver declined (handled by listener, but check time here)
                const now = Date.now();
                const elapsed = now - (activeTrip.requestTime || now);
                
                // If 2 minutes passed, re-assign
                if (elapsed > 120000) {
                     await assignNextDriver(tripId);
                }
            }, 5000); // Check every 5s
        }
        
        async function assignNextDriver(tripId) {
            // Re-fetch trip to get latest declined list
            const snap = await get(ref(db, `trips/${tripId}`));
            const trip = snap.val();
            if (!trip || trip.status !== 'pending') return;

            const queue = trip.driverQueue || [];
            const declined = trip.declinedDriverIds || [];
            const currentDriver = trip.requestedDriverId;
            
            // Mark current as declined if timed out
            if (currentDriver && !declined.includes(currentDriver)) {
                declined.push(currentDriver);
            }

            // Find next available
            const nextDriver = queue.find(id => !declined.includes(id));

            if (nextDriver) {
                await update(ref(db, `trips/${tripId}`), {
                    requestedDriverId: nextDriver,
                    requestTime: Date.now(), // Reset timer for new driver
                    declinedDriverIds: declined
                });
            } else {
                // No more drivers
                // Keep searching or maybe notify admin? For now, we just loop or stay pending.
                // Optionally refresh queue here.
            }
        }
        
        function listenToTripUpdates(tripId) {
            const tripRef = ref(db, `trips/${tripId}`);
            tripListener = onValue(tripRef, async (snapshot) => {
                if (!snapshot.exists()) {
                    if (activeTrip && activeTrip.status !== 'completed') {
                         activeTrip.status = 'completed';
                         updateTripStatusUI('completed');
                    }
                    return;
                }
                const tripData = snapshot.val();
                
                // Check if driver declined (Driver app pushes to declinedDriverIds)
                if (tripData.declinedDriverIds && activeTrip.declinedDriverIds) {
                    if (tripData.declinedDriverIds.length > activeTrip.declinedDriverIds.length) {
                         // A driver declined, immediately try next
                         await assignNextDriver(tripId);
                    }
                }

                const previousStatus = activeTrip ? activeTrip.status : null;
                activeTrip = { ...activeTrip, ...tripData };
                
                if (tripData.status !== previousStatus) {
                     switch(tripData.status) {
                        case 'accepted':
                            clearInterval(tripMonitorInterval);
                            tripAcceptSound.play();
                            showNotification("Pyapay", "ယာဉ်မောင်းတစ်ဦး သင်၏ခရီးစဉ်ကို လက်ခံလိုက်ပါပြီ!");
                            const driverSnap = await get(ref(db, `drivers/${tripData.driverId}`));
                            activeTrip.driverDetails = driverSnap.exists() ? driverSnap.val() : { name: 'Unknown Driver' };
                            updateTripStatusUI('accepted', { driver: activeTrip.driverDetails });
                            listenToDriverLocation(tripData.driverId);
                            break;
                        case 'at_pickup': 
                            updateTripStatusUI('at_pickup'); 
                            showNotification("Pyapay", "ယာဉ်မောင်း ရောက်ရှိပါပြီ");
                            break;
                        case 'to_dropoff': updateTripStatusUI('to_dropoff'); break;
                        case 'cancelled': 
                            alert('ခရီးစဉ် ပယ်ဖျက်လိုက်ပါသည်။'); 
                            // Ensure it's saved to history even if cancelled by driver/admin
                            const cancelledTrip = { ...activeTrip, status: 'cancelled', completedAt: Date.now() };
                            await set(ref(db, `passengers/${currentUser.uid}/completedTrips/${activeTrip.id}`), cancelledTrip);
                            resetToMainView(); 
                            break;
                     }
                }
            });
        }
        
        function listenToDriverLocation(driverId) {
            if (driverLocationListener) off(ref(db, `driverLocations/${driverId}`), 'value', driverLocationListener);
            const driverLocRef = ref(db, `driverLocations/${driverId}`);
            driverLocationListener = onValue(driverLocRef, (snapshot) => {
                if (!snapshot.exists() || !activeTrip) return;
                const loc = snapshot.val();
                
                if (activeDriverMarker) {
                    activeDriverMarker.setLatLng([loc.lat, loc.lng]);
                    activeDriverMarker.setIcon(driverIcon(loc.heading));
                } else {
                    activeDriverMarker = L.marker([loc.lat, loc.lng], { icon: driverIcon(loc.heading) }).addTo(map);
                }

                if (routeControl) map.removeControl(routeControl);
                if (driverRouteControl) map.removeControl(driverRouteControl);

                const isPickingUp = activeTrip.status === 'accepted';
                const isToDropoff = activeTrip.status === 'to_dropoff';

                if (isPickingUp) {
                    driverRouteControl = L.Routing.control({
                        waypoints: [ L.latLng(loc.lat, loc.lng), L.latLng(activeTrip.pickup.lat, activeTrip.pickup.lng) ],
                        createMarker: () => null, addWaypoints: false, fitSelectedRoutes: false,
                        lineOptions: { styles: [{color: '#FBBF24', opacity: 0.9, weight: 6}] }
                    }).addTo(map);
                }

                if (isPickingUp || activeTrip.status === 'at_pickup' || isToDropoff) {
                    const startPoint = isToDropoff ? L.latLng(loc.lat, loc.lng) : L.latLng(activeTrip.pickup.lat, activeTrip.pickup.lng);
                    routeControl = L.Routing.control({
                        waypoints: [ startPoint, L.latLng(activeTrip.dropoff.lat, activeTrip.dropoff.lng) ],
                        createMarker: () => null, addWaypoints: false, fitSelectedRoutes: false, 
                        lineOptions: { styles: [{color: '#45C9FF', opacity: 0.8, weight: 6}] }
                    }).addTo(map);
                }

                const bounds = L.latLngBounds([ [loc.lat, loc.lng], [activeTrip.dropoff.lat, activeTrip.dropoff.lng], [currentLocation.lat, currentLocation.lng] ]);
                map.fitBounds(bounds, { paddingTopLeft: [50, 50], paddingBottomRight: [50, 300], animate: true });
                if (driverRouteControl) {
                    driverRouteControl.on('routesfound', (e) => {
                         const etaEl = document.getElementById('driver-eta');
                         if(etaEl) etaEl.innerText = `~${Math.round(e.routes[0].summary.totalTime / 60)} မိနစ်အတွင်း ရောက်ပါမည်`;
                    });
                }
            });
        }

        function updateTripStatusUI(status, data = {}) {
            const panel = dom.tripStatusPanel;
            panel.innerHTML = '';
            
            const tokenHeader = activeTrip && activeTrip.token ? `<div class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold w-fit mx-auto mb-2 border border-blue-200">Token: ${activeTrip.token}</div>` : '';

            if (status === 'searching') {
                panel.innerHTML = `<div class="text-center p-4">
                    ${tokenHeader}
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#45C9FF] mx-auto mb-4"></div>
                    <h3 class="text-xl font-bold text-slate-800">Driver ရှာဖွေနေပါသည်...</h3>
                    <p class="text-slate-500 mt-2">${selectedDriverForBooking ? 'သင်ရွေးချယ်ထားသော ယာဉ်မောင်းကို ဆက်သွယ်နေသည်...' : 'အနီးဆုံး ယာဉ်မောင်းကို ရှာဖွေနေပါသည်'}</p>
                    <button id="cancel-trip-button" class="w-full bg-red-50 text-red-600 border border-red-200 font-bold py-3 mt-6 rounded-xl hover:bg-red-100 transition">ခရီးစဉ် ပယ်ဖျက်မည်</button>
                </div>`;
                document.getElementById('cancel-trip-button').onclick = cancelTrip;
            } else if (status === 'accepted' || status === 'at_pickup' || status === 'to_dropoff') {
                const title = status === 'accepted' ? 'Driver ရောက်လာတော့မည်' : (status === 'at_pickup' ? 'ကားရောက်လာပါပြီ' : 'ခရီးစဉ်အတွင်း');
                panel.innerHTML = `<div class="p-2 text-center">
                    ${tokenHeader}
                    <h3 class="text-xl font-bold text-theme">${title}</h3>
                    ${status === 'accepted' ? '<p class="text-amber-500 font-semibold" id="driver-eta">အချိန် တွက်ချက်နေသည်...</p>' : ''}
                    <div class="bg-slate-50 border border-slate-100 p-4 rounded-xl mt-4">
                        <div class="w-16 h-16 rounded-full bg-slate-200 mx-auto mb-2 overflow-hidden">
                             ${activeTrip.driverDetails?.profilePic ? `<img src="${activeTrip.driverDetails.profilePic}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-slate-500 font-bold text-2xl">?</div>'}
                        </div>
                        <p class="text-lg font-bold text-slate-800">${activeTrip.driverDetails?.name || 'Driver'}</p>
                        <p class="text-slate-500">${activeTrip.driverDetails?.carPlate || 'N/A'} - ${activeTrip.driverDetails?.carModel || 'Car'}</p>
                    </div>
                    <div class="flex justify-around mt-4 gap-4">
                         <button id="chat-driver-button" class="relative bg-blue-100 text-theme font-bold py-3 px-6 rounded-xl flex-1 hover:bg-blue-200 transition">Chat</button>
                        <a href="tel:${activeTrip.driverDetails?.phone || passengerInfo.phone}" class="bg-green-100 text-green-600 font-bold py-3 px-6 rounded-xl flex-1 hover:bg-green-200 transition text-center">Call</a>
                    </div>
                </div>`;
                document.getElementById('chat-driver-button').onclick = showChatModal;
                updateChatBadge();
            } else if (status === 'completed') {
                dom.ratingModal.classList.remove('hidden');
                currentRating = 0;
                document.querySelectorAll('.star-rating span').forEach(s => s.classList.remove('active'));
                
                panel.innerHTML = `<div class="text-center p-4">
                    ${tokenHeader}
                    <h3 class="text-2xl font-bold text-green-600">ခရီးစဉ် ပြီးဆုံးပါပြီ</h3>
                    <p class="text-lg mt-2 text-slate-700">ကျသင့်ငွေ: <span class="font-bold">${activeTrip.fare.toLocaleString()} Ks</span></p>
                    <button id="close-summary-button" class="w-full bg-theme text-white font-bold py-3 mt-6 rounded-xl shadow-lg shadow-blue-500/30">ပိတ်မည်</button>
                </div>`;
                document.getElementById('close-summary-button').onclick = resetToMainView;
            }
        }
        
        async function cancelTrip() {
            if (!activeTrip || !activeTrip.id) return;
            if (confirm('ခရီးစဉ်ကို ပယ်ဖျက်ရန် သေချာပါသလား?')) {
                // Save to history before removing/updating
                const cancelledTrip = { ...activeTrip, status: 'cancelled', completedAt: Date.now() };
                await set(ref(db, `passengers/${currentUser.uid}/completedTrips/${activeTrip.id}`), cancelledTrip);
                await update(ref(db, `trips/${activeTrip.id}`), { status: 'cancelled' });
            }
        }
        
        async function submitRating() {
            if(currentRating === 0) return alert('ကျေးဇူးပြု၍ အမှတ်ပေးပါ');
            if(activeTrip && activeTrip.driverId) {
                await push(ref(db, `drivers/${activeTrip.driverId}/ratings`), {
                    stars: currentRating,
                    tripId: activeTrip.id,
                    timestamp: serverTimestamp()
                });
                alert('အမှတ်ပေးမှုအတွက် ကျေးဇူးတင်ပါသည်!');
            }
            dom.ratingModal.classList.add('hidden');
            resetToMainView();
        }

        function showProfile() {
            dom.profileModal.classList.remove('hidden');
            document.getElementById('profile-name').innerText = passengerInfo.name;
            document.getElementById('profile-phone').innerText = passengerInfo.phone;
            document.getElementById('profile-initial').innerText = passengerInfo.name.charAt(0).toUpperCase();
            loadTripHistory();
        }
        
        async function loadTripHistory() {
            const historyContent = document.getElementById('history-content');
            historyContent.innerHTML = `<div class="flex justify-center p-4"><div class="loading-spinner w-6 h-6 border-slate-300 border-t-theme"></div></div>`;
            
            try {
                // Fetch all trips
                const snapshot = await get(ref(db, `passengers/${currentUser.uid}/completedTrips`));
                historyContent.innerHTML = '';
                
                if (snapshot.exists()) {
                    const trips = [];
                    snapshot.forEach(child => {
                        const t = child.val();
                        if (t) trips.push(t);
                    });
                    
                    // Robust sorting (handle missing dates)
                    trips.sort((a,b) => {
                        const timeA = a.completedAt || a.requestTime || 0;
                        const timeB = b.completedAt || b.requestTime || 0;
                        return timeB - timeA;
                    }); 

                    trips.forEach(trip => {
                        // Safe Accessors
                        const pickupAddr = trip.pickupAddress || (trip.pickup ? `${trip.pickup.lat.toFixed(4)}, ${trip.pickup.lng.toFixed(4)}` : 'Unknown');
                        const dropoffAddr = trip.dropoffAddress || (trip.dropoff ? `${trip.dropoff.lat.toFixed(4)}, ${trip.dropoff.lng.toFixed(4)}` : 'Unknown');
                        const pickupShort = pickupAddr.split(',')[0];
                        const dropoffShort = dropoffAddr.split(',')[0];
                        
                        let statusColor = 'text-slate-500';
                        let priceDisplay = `${(trip.fare || 0).toLocaleString()} Ks`;
                        let statusText = 'Completed';

                        if (trip.status === 'cancelled') {
                            statusColor = 'text-red-500';
                            priceDisplay = 'Cancelled';
                            statusText = 'Cancelled';
                        } else if (trip.status === 'completed') {
                            statusColor = 'text-green-600';
                            statusText = 'Success';
                        }

                        const timestamp = trip.completedAt || trip.requestTime || Date.now();
                        const dateObj = new Date(timestamp);
                        const dateStr = !isNaN(dateObj.getTime()) ? dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
                        
                         historyContent.innerHTML += `<div class="bg-white p-3 rounded-xl border border-slate-200 mb-3 shadow-sm">
                            <div class="flex justify-between items-center mb-2 border-b border-slate-50 pb-2">
                                <span class="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded font-mono font-bold tracking-wider">${trip.token || 'N/A'}</span>
                                <span class="text-[10px] text-slate-400 font-medium">${dateStr}</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-start gap-2">
                                     <div class="w-2 h-2 rounded-full bg-blue-500 mt-1 shrink-0"></div>
                                     <p class="text-xs text-slate-600 line-clamp-1">${pickupShort}</p>
                                </div>
                                 <div class="flex items-start gap-2">
                                     <div class="w-2 h-2 rounded-full ${trip.status === 'cancelled' ? 'bg-slate-300' : 'bg-red-500'} mt-1 shrink-0"></div>
                                     <p class="text-sm font-bold text-slate-800 line-clamp-1">${dropoffShort}</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-end mt-3 pt-2 border-t border-slate-50">
                                <span class="text-xs font-bold ${trip.status === 'cancelled' ? 'text-red-400 bg-red-50' : 'text-green-600 bg-green-50'} px-2 py-1 rounded">${statusText}</span>
                                <p class="font-bold text-slate-800">${priceDisplay}</p>
                            </div>
                        </div>`;
                    });
                } else historyContent.innerHTML = `<p class="text-slate-400 text-center py-8">ခရီးစဉ်မှတ်တမ်း မရှိပါ။</p>`;
            } catch (e) { 
                console.error(e);
                historyContent.innerHTML = `<div class="text-center py-8"><p class="text-red-400 mb-2">မှတ်တမ်းရယူမရနိုင်ပါ</p><button onclick="loadTripHistory()" class="text-blue-500 underline text-sm">ပြန်လည်ကြိုးစားပါ</button></div>`; 
            }
        }
        
        function saveFavorites() {
            localStorage.setItem('pyapay_home', document.getElementById('home-address-input').value);
            localStorage.setItem('pyapay_work', document.getElementById('work-address-input').value);
            alert('သိမ်းဆည်းလိုက်ပါပြီ။'); dom.profileModal.classList.add('hidden');
        }

        function showChatModal() {
            unreadMessages = 0; updateChatBadge();
            dom.chatModal.classList.remove('hidden');
            dom.chatModal.innerHTML = `<div class="absolute inset-0 bg-black/60 z-30 flex justify-center items-end backdrop-blur-sm" id="chat-backdrop"><div class="bg-white rounded-t-2xl w-full max-w-md flex flex-col h-[85vh] shadow-2xl"><header class="flex items-center p-4 border-b border-slate-100"><button id="close-chat-button" class="p-2 -ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-500"><polyline points="15 18 9 12 15 6"></polyline></svg></button><h2 class="text-xl font-bold text-slate-800 mx-auto">ယာဉ်မောင်းနှင့် စကားပြောရန်</h2><div class="w-10"></div></header><main id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50"></main><footer class="p-4 border-t border-slate-100 bg-white"><form id="chat-form" class="flex gap-2"><input id="chat-input" type="text" placeholder="စာရိုက်ပါ..." class="flex-1 bg-slate-100 rounded-full py-2 px-4 text-slate-800 focus:outline-none focus:ring-2 focus-ring-theme"><button type="submit" class="bg-theme rounded-full p-3 text-white shadow"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button></form></footer></div></div>`;
            document.getElementById('close-chat-button').onclick = () => dom.chatModal.classList.add('hidden');
            document.getElementById('chat-backdrop').onclick = (e) => { if(e.target.id === 'chat-backdrop') dom.chatModal.classList.add('hidden'); };
            document.getElementById('chat-form').onsubmit = handleSendMessage;
            listenForChatMessages();
        }

        function listenForChatMessages() {
            const messagesRef = query(ref(db, `chats/${activeTrip.id}/messages`), orderByChild('timestamp'));
            const chatMessagesEl = document.getElementById('chat-messages');
            chatMessagesEl.innerHTML = '';
            if (chatListener) off(messagesRef, 'child_added', chatListener);
            chatListener = onChildAdded(messagesRef, (snapshot) => {
                const msg = snapshot.val();
                if(msg.sender === 'driver' && dom.chatModal.classList.contains('hidden')) {
                    unreadMessages++; updateChatBadge(); playDoubleBeep();
                    showNotification("Driver Message", msg.text);
                }
                chatMessagesEl.innerHTML += `<div class="flex items-end gap-2 ${msg.sender === 'passenger' ? 'justify-end' : 'justify-start'}"><div class="max-w-xs px-4 py-2 rounded-2xl ${msg.sender === 'passenger' ? 'bg-theme text-white rounded-br-none shadow-md' : 'bg-white text-slate-800 rounded-bl-none shadow-sm border border-slate-100'}"><p>${msg.text}</p></div></div>`;
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            });
        }
        
        function updateChatBadge() {
            const chatButton = document.getElementById('chat-driver-button');
            if (!chatButton) return;
            let badge = chatButton.querySelector('.chat-badge');
            if (unreadMessages > 0) {
                if (!badge) { badge = document.createElement('span'); badge.className = 'chat-badge'; chatButton.appendChild(badge); }
                badge.innerText = unreadMessages; badge.classList.remove('hidden');
            } else if (badge) badge.classList.add('hidden');
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text === '' || !activeTrip) return;
            await set(ref(db, `chats/${activeTrip.id}/messages/${Date.now()}`), { text, sender: 'passenger', timestamp: serverTimestamp() });
            input.value = '';
        }

        function resetToMainView(fullReset = true) {
            if(tripMonitorInterval) clearInterval(tripMonitorInterval);
            if (activeTrip && tripListener) off(ref(db, `trips/${activeTrip.id}`), 'value', tripListener);
            if (activeTrip && activeTrip.driverId && driverLocationListener) off(ref(db, `driverLocations/${activeTrip.driverId}`), 'value', driverLocationListener);
            if (activeTrip && chatListener) off(ref(db, `chats/${activeTrip.id}/messages`), 'child_added', chatListener);
            if (routeControl) { map.removeControl(routeControl); routeControl = null; map.setView(currentLocation, 16); }
            if (driverRouteControl) { map.removeControl(driverRouteControl); driverRouteControl = null; }
            if (activeDriverMarker) { activeDriverMarker.remove(); activeDriverMarker = null; }
            if (fullReset) { selectedDriverForBooking = null; dom.directBookingAlert.classList.add('hidden'); }
            activeTrip = null; tripListener = null; driverLocationListener = null; chatListener = null;
            pickupLocation = null; dropoffLocation = null;
            dom.pickupInput.value = ''; dom.dropoffInput.value = ''; 
            dom.searchResults.innerHTML = ''; dom.searchResults.classList.add('hidden');
            dom.promoCodeInput.value = '';
            selectedVehicleType = 'Normal'; handleVehicleSelection(dom.vehicleOptions.querySelector('[data-type="Normal"]'));
            dom.tripStatusPanel.classList.add('hidden'); dom.confirmPanel.classList.add('hidden');
            dom.searchPanel.classList.remove('hidden'); dom.mainHeader.classList.remove('hidden');
            
            // Reset Map Picking UI
            isPickingOnMap = false; pickingTarget = null;
            dom.mapCenterPin.classList.add('hidden');
            dom.mapConfirmContainer.classList.add('hidden');
            dom.recenterBtn.classList.remove('hidden');

            listenForNearbyDrivers();
            
            // Re-init pickup with current loc
            if(currentLocation) {
                pickupLocation = { lat: currentLocation.lat, lng: currentLocation.lng, address: "လက်ရှိနေရာ" };
                dom.pickupInput.value = "";
            }
        }

        initApp();
    </script>
</body>
</html>
