
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyapay Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --bg-body: #f1f5f9; --bg-card: #ffffff; --bg-sidebar: #1e293b;
            --text-primary: #1e293b; --text-secondary: #64748b;
            --accent: #3b82f6; --accent-hover: #2563eb;
        }
        body { background-color: var(--bg-body); color: var(--text-primary); font-family: 'Inter', sans-serif; }
        .sidebar { background-color: var(--bg-sidebar); width: 16rem; transition: transform 0.3s ease; }
        .card { background-color: var(--bg-card); border: 1px solid #e2e8f0; }
        .btn-primary { background-color: var(--accent); color: white; font-weight: 600; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; z-index: 50; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
        }

        .nav-link { border-left: 4px solid transparent; transition: all 0.2s; }
        .nav-link:hover { background-color: rgba(255,255,255,0.05); }
        .nav-link.active { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; border-left-color: #3b82f6; }
        
        .leaflet-container .leaflet-control-attribution { display: none; }
        .leaflet-routing-container { display: none; }
        
        .tab-btn.active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .noti-badge { background-color: #ef4444; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 9999px; font-weight: bold; margin-left: auto; }
        .driver-pending-dot { width: 10px; height: 10px; background-color: #ef4444; border-radius: 50%; display: inline-block; margin-left: 8px; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); vertical-align: middle; }
        
        /* Map Picking Styles */
        #map-center-pin {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%); /* Tip of pin at center */
            z-index: 1000; pointer-events: none;
            transition: transform 0.2s;
        }
    </style>
</head>
<body class="text-sm h-screen overflow-hidden flex flex-col">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-2xl shadow-xl border border-slate-200">
            <div class="text-center">
                <h1 class="text-4xl font-extrabold text-blue-600 mb-2">Pyapay</h1>
                <p class="text-slate-500 font-medium">Admin Control Center</p>
            </div>
            <form id="login-form" class="space-y-4 mt-6">
                <input id="email" type="email" placeholder="Email" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input id="password" type="password" placeholder="Password" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p id="login-error" class="text-sm text-red-500 text-center hidden"></p>
                <button type="submit" class="w-full py-3 rounded-lg btn-primary shadow-lg shadow-blue-500/20">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="dashboard" class="hidden flex h-full relative">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

        <aside id="sidebar" class="sidebar flex flex-col border-r border-slate-700">
            <div class="h-16 flex items-center px-6 border-b border-slate-700 bg-slate-800">
                <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center text-white font-bold text-lg mr-3">P</div>
                <span class="text-xl font-bold text-white tracking-tight">Pyapay Admin</span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                <a href="#dashboard-view" class="nav-link active flex items-center gap-3 px-6 py-3 text-slate-300">Dashboard</a>
                <a href="#dispatch-view" class="nav-link flex items-center gap-3 px-6 py-3 text-slate-300 bg-blue-900/20 text-blue-400 border-l-blue-500">Manual Dispatch</a>
                <a href="#drivers-view" class="nav-link flex items-center gap-3 px-6 py-3 text-slate-300">
                    Drivers List
                    <span id="drivers-badge" class="noti-badge hidden">0</span>
                </a>
                <a href="#trips-view" class="nav-link flex items-center gap-3 px-6 py-3 text-slate-300">Trips & Revenue</a>
                <a href="#map-view" class="nav-link flex items-center gap-3 px-6 py-3 text-slate-300">Live Map & Tools</a>
                <a href="#ads-view" class="nav-link flex items-center gap-3 px-6 py-3 text-slate-300">Ads Manager</a>
                <a href="#settings-view" class="nav-link flex items-center gap-3 px-6 py-3 text-slate-300">Settings & Prices</a>
            </nav>
            <div class="p-4 border-t border-slate-700 bg-slate-800">
                <button id="logout-button" class="w-full px-4 py-2 bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white rounded-lg transition">Sign Out</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-slate-50">
            <header class="h-16 flex items-center justify-between px-6 bg-white/80 backdrop-blur border-b border-slate-200 sticky top-0 z-30">
                <div class="flex items-center gap-4">
                    <button id="mobile-menu-btn" class="md:hidden text-slate-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                    <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-4 md:p-8 scroll-smooth" id="main-scroll">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view-content space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6 rounded-xl shadow-sm border-l-4 border-l-blue-500">
                            <p class="text-slate-500 text-sm font-semibold uppercase">Total Drivers</p>
                            <h3 id="stat-drivers" class="text-3xl font-bold text-slate-800 mt-1">0</h3>
                        </div>
                        <div class="card p-6 rounded-xl shadow-sm border-l-4 border-l-emerald-500">
                            <p class="text-slate-500 text-sm font-semibold uppercase">Online Now</p>
                            <h3 id="stat-online" class="text-3xl font-bold text-emerald-600 mt-1">0</h3>
                        </div>
                        <div class="card p-6 rounded-xl shadow-sm border-l-4 border-l-amber-500">
                            <p class="text-slate-500 text-sm font-semibold uppercase">Active Trips</p>
                            <h3 id="stat-trips" class="text-3xl font-bold text-amber-500 mt-1">0</h3>
                        </div>
                         <div class="card p-6 rounded-xl shadow-sm border-l-4 border-l-purple-500">
                            <p class="text-slate-500 text-sm font-semibold uppercase">Total Commission</p>
                            <h3 id="stat-revenue" class="text-3xl font-bold text-purple-600 mt-1">0 Ks</h3>
                        </div>
                    </div>
                </div>

                <!-- Manual Dispatch View -->
                <div id="dispatch-view" class="view-content hidden h-full flex flex-col">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
                        <div class="col-span-1 space-y-4">
                            <div class="card p-4 rounded-xl">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="font-bold text-lg">Create Trip</h3>
                                    <button onclick="resetDispatchMap()" class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded hover:bg-red-50">Reset Map</button>
                                </div>
                                <div class="space-y-3">
                                    <input id="disp-phone" type="text" placeholder="Passenger Phone (Required)" class="w-full border p-2 rounded">
                                    <div class="p-2 bg-blue-50 border border-blue-200 rounded">
                                        <label class="text-xs text-blue-500 font-bold">PICKUP</label>
                                        <p id="disp-pickup-addr" class="text-sm font-semibold truncate">Select on Map</p>
                                        <button onclick="setPickMode('pickup')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded mt-1">Set Pickup</button>
                                    </div>
                                    <div class="p-2 bg-red-50 border border-red-200 rounded">
                                        <label class="text-xs text-red-500 font-bold">DROPOFF</label>
                                        <p id="disp-dropoff-addr" class="text-sm font-semibold truncate">Select on Map</p>
                                        <button onclick="setPickMode('dropoff')" class="text-xs bg-red-600 text-white px-2 py-1 rounded mt-1">Set Dropoff</button>
                                    </div>
                                    <div id="disp-fare-info" class="hidden bg-slate-100 p-2 rounded">
                                        <p>Dist: <span id="disp-dist" class="font-bold">-</span> km</p>
                                        <p>Est. Fare: <span id="disp-fare" class="font-bold text-green-600 text-lg">-</span> Ks</p>
                                    </div>
                                    <button id="btn-dispatch" onclick="createManualTrip()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg" disabled>Dispatch Driver</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-2 relative card rounded-xl overflow-hidden h-[500px] md:h-auto">
                            <div id="dispatch-map" class="absolute inset-0 z-10"></div>
                            <div id="map-toast" class="hidden absolute top-4 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full z-20 shadow-xl">Use Pin to Select Location...</div>
                            
                            <!-- Fixed Center Pin for Admin Dispatch -->
                            <div id="map-center-pin" class="hidden z-50">
                                <img id="pin-image" src="" class="w-10 h-10 drop-shadow-2xl" alt="Pin">
                                <div class="w-2 h-2 bg-black/30 rounded-full absolute -bottom-1 left-1/2 -translate-x-1/2 blur-[1px]"></div>
                            </div>

                            <!-- Confirm Button Overlay -->
                            <button id="confirm-pick-btn" onclick="confirmDispatchPick()" class="hidden absolute bottom-8 left-1/2 -translate-x-1/2 z-50 bg-slate-800 text-white font-bold py-2 px-6 rounded-full shadow-xl hover:bg-slate-700">Confirm Location</button>
                            
                            <!-- Recenter Button for Dispatch -->
                            <button id="dispatch-recenter-btn" class="absolute bottom-6 right-6 z-20 bg-white text-blue-600 p-3 rounded-full shadow-xl hover:bg-slate-50 border border-slate-200">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Drivers View -->
                <div id="drivers-view" class="view-content hidden space-y-6">
                    <div class="flex justify-between">
                         <input type="text" id="driver-search" placeholder="Search drivers..." class="bg-white border border-slate-300 text-slate-800 rounded-lg px-4 py-2 w-64 shadow-sm">
                         <button id="add-driver-btn" class="btn-primary py-2 px-4 rounded-lg shadow-sm">Add Driver</button>
                    </div>
                    <div class="card rounded-xl overflow-hidden shadow-sm">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200"><tr><th class="p-4">Name</th><th class="p-4">NRC</th><th class="p-4">Car</th><th class="p-4">Status</th><th class="p-4 text-right">Actions</th></tr></thead>
                            <tbody id="drivers-table" class="divide-y divide-slate-100 text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Trips View -->
                <div id="trips-view" class="view-content hidden space-y-6">
                    <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800">Trip Management</h3>
                        <div class="relative">
                            <input type="text" id="trip-search-input" placeholder="Search by Token (e.g. T-1234)..." class="pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm w-64 focus:ring-2 focus:ring-blue-500 outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 absolute left-3 top-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                        </div>
                    </div>
                    <div class="card rounded-xl overflow-hidden shadow-sm">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                                <tr>
                                    <th class="p-4">Token</th>
                                    <th class="p-4">Time</th>
                                    <th class="p-4">Route</th>
                                    <th class="p-4">Fare</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="trips-list-table" class="divide-y divide-slate-100 text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Map View -->
                <div id="map-view" class="view-content hidden h-full flex flex-col relative">
                     <div class="absolute top-4 left-16 z-20 flex gap-2">
                        <button id="measure-tool-btn" class="bg-white text-slate-700 p-2 rounded-lg border border-slate-300 hover:bg-slate-50 shadow-md flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5.5 8.5 9 12l-3.5 3.5L2 12l3.5-3.5Z"/><path d="m12 12 3.5 3.5L12 19l-3.5-3.5L12 12Z"/><path d="M19 12l-3.5-3.5L12 12l3.5 3.5L19 12Z"/><path d="m5 12-3.5-3.5L5 5l3.5 3.5L5 12Z"/><path d="m19 12 3.5-3.5L19 5l-3.5 3.5L19 12Z"/></svg>
                             Measure Route
                        </button>
                        <div id="measure-info" class="hidden bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-700 shadow-lg">
                            Click two points on map
                        </div>
                     </div>

                    <div class="card rounded-xl border-0 overflow-hidden shadow-lg flex-1 relative h-[600px] md:h-full">
                        <div id="admin-map" class="absolute inset-0 z-10 bg-slate-100"></div>
                        <button id="recenter-btn" class="absolute bottom-6 right-6 z-20 bg-blue-600 text-white p-3 rounded-full shadow-xl hover:bg-blue-50">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="settings-view" class="view-content hidden space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Pricing -->
                        <div class="card p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">Pricing Configuration</h3>
                            <form id="settings-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-600 mb-1">Commission Rate (%)</label>
                                    <input id="commission-input" type="number" min="0" max="100" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. 14">
                                    <p class="text-xs text-slate-500 mt-1">Percentage taken from the fare.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-600 mb-1">Platform Fee (Ks)</label>
                                    <input id="platform-fee-input" type="number" min="0" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. 100">
                                    <p class="text-xs text-slate-500 mt-1">Fixed amount taken per trip.</p>
                                </div>
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-semibold text-slate-600 mb-1">Base Fare (Ks)</label>
                                    <input id="base-fare-input" type="number" min="0" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. 1500">
                                    <p class="text-xs text-slate-500 mt-1">Starting price for every trip.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-600 mb-1">Price Per KM (Ks)</label>
                                    <input id="price-per-km-input" type="number" min="0" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. 500">
                                    <p class="text-xs text-slate-500 mt-1">Added cost for each kilometer.</p>
                                </div>
                                <button type="submit" class="btn-primary w-full py-2 rounded-lg mt-4">Save Pricing</button>
                            </form>
                        </div>

                        <!-- Contact & Payments -->
                        <div class="card p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">Contact & Payment Info</h3>
                            <form id="contact-settings-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold text-blue-600 mb-2">Passenger Direct Hire Contacts</label>
                                    <div class="space-y-2">
                                        <input id="contact-phone-1" type="text" class="w-full border border-slate-300 p-2 rounded" placeholder="Phone 1">
                                        <input id="contact-phone-2" type="text" class="w-full border border-slate-300 p-2 rounded" placeholder="Phone 2">
                                    </div>
                                </div>
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-bold text-green-600 mb-2">Driver Payment Info (Wallet)</label>
                                    <div>
                                        <label class="text-xs text-slate-500">KPay Name & Number</label>
                                        <input id="pay-kpay" type="text" class="w-full border border-slate-300 p-2 rounded" placeholder="e.g. 09123456789 (Admin Name)">
                                    </div>
                                    <div class="mt-2">
                                        <label class="text-xs text-slate-500">WavePay Name & Number</label>
                                        <input id="pay-wave" type="text" class="w-full border border-slate-300 p-2 rounded" placeholder="e.g. 09987654321 (Admin Name)">
                                    </div>
                                </div>
                                <button type="submit" class="btn-primary w-full py-2 rounded-lg mt-4">Save Contact & Payment</button>
                            </form>
                        </div>

                        <!-- Branding Configuration (New) -->
                        <div class="card p-6 rounded-xl shadow-sm border border-slate-200 lg:col-span-2">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">App Branding (Logos)</h3>
                            <form id="branding-form" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="p-4 bg-blue-50 border border-blue-100 rounded-lg">
                                        <label class="block text-sm font-bold text-blue-700 mb-2">Driver App Loading Logo (PNG)</label>
                                        <input id="driver-loading-logo-input" type="file" accept="image/png" class="w-full border border-blue-300 p-2 rounded text-sm bg-white">
                                        <p class="text-xs text-blue-500 mt-1">Replaces text on Driver App loading screen.</p>
                                        <img id="preview-driver-loading-logo" class="h-16 mt-2 object-contain hidden" alt="Preview">
                                    </div>
                                    <div class="p-4 bg-orange-50 border border-orange-100 rounded-lg">
                                        <label class="block text-sm font-bold text-orange-700 mb-2">Passenger App Loading Logo (PNG)</label>
                                        <input id="passenger-loading-logo-input" type="file" accept="image/png" class="w-full border border-orange-300 p-2 rounded text-sm bg-white">
                                        <p class="text-xs text-orange-500 mt-1">Replaces text on Passenger App loading screen.</p>
                                        <img id="preview-passenger-loading-logo" class="h-16 mt-2 object-contain hidden" alt="Preview">
                                    </div>
                                    <div class="col-span-1 md:col-span-2">
                                        <label class="block text-sm font-bold text-slate-600 mb-2">Passenger Home Header Logo (PNG)</label>
                                        <input id="home-logo-input" type="file" accept="image/png" class="w-full border border-slate-300 p-2 rounded text-sm">
                                        <img id="preview-home-logo" class="h-10 mt-2 object-contain hidden" alt="Preview">
                                    </div>
                                </div>
                                <button type="submit" class="btn-primary w-full py-2 rounded-lg mt-4">Save Branding</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Ads Manager View -->
                <div id="ads-view" class="view-content hidden space-y-6">
                    <div class="flex gap-6 flex-col md:flex-row">
                        <div class="card p-6 rounded-xl shadow-sm border border-slate-200 flex-1">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">Create New Ad</h3>
                            <form id="create-ad-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-600 mb-1">Title</label>
                                    <input id="ad-title" type="text" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. 50% Off Promo" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-600 mb-1">Position</label>
                                    <select id="ad-position" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800 outline-none">
                                        <option value="top">Top (Auto Slider)</option>
                                        <option value="bottom">Bottom (Manual Scroll)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-600 mb-1">Ad Images (Upload Multiple)</label>
                                    <input id="ad-image" type="file" accept="image/*" multiple class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" required>
                                    <p class="text-xs text-slate-500 mt-1">Select one or more images from your device (Max 500KB each).</p>
                                </div>
                                <button type="submit" class="btn-primary w-full py-2 rounded-lg mt-4">Publish Ads</button>
                            </form>
                        </div>
                        
                        <div class="card p-6 rounded-xl shadow-sm border border-slate-200 flex-[2]">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">Active Ads</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                                        <tr>
                                            <th class="p-3">Preview</th>
                                            <th class="p-3">Title</th>
                                            <th class="p-3">Position</th>
                                            <th class="p-3 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ads-table-body" class="divide-y divide-slate-100 text-sm">
                                        <!-- Ads populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- ... (Modals remain unchanged) ... -->
    <!-- Add Driver Modal -->
    <div id="add-driver-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg border border-slate-200 p-6">
             <h3 class="text-xl font-bold text-slate-800 mb-4">Add Driver Account</h3>
             <form id="add-driver-form" class="space-y-3">
                 <input name="name" placeholder="Name" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800" required>
                 <input name="nrc" placeholder="NRC (e.g., 12/OkTaNa(N)123456)" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800" required>
                 <input name="email" placeholder="Email (Login ID)" type="email" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800" required>
                 <input name="password" placeholder="Password" type="password" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800" required>
                 <input name="phone" placeholder="Phone" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800" required>
                 <input name="carModel" placeholder="Car Model" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800" required>
                 <input name="carPlate" placeholder="Car Plate" class="w-full bg-slate-50 border border-slate-300 p-2 rounded text-slate-800" required>
                 <div class="flex justify-end gap-2 mt-4">
                     <button type="button" onclick="closeModal('add-driver-modal')" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded">Cancel</button>
                     <button type="submit" class="btn-primary px-4 py-2 rounded">Create Account</button>
                 </div>
             </form>
        </div>
    </div>
    
    <!-- Details Modal -->
    <div id="details-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl border border-slate-200 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 id="details-title" class="text-xl font-bold text-slate-800">Driver Details</h3>
                <button onclick="closeModal('details-modal')" class="text-slate-400 hover:text-slate-800"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="px-6 py-2 border-b border-slate-100 flex gap-6 bg-slate-50">
                <button class="tab-btn active font-medium py-2 text-slate-600 hover:text-blue-600" data-tab="info">Information</button>
                <button class="tab-btn font-medium py-2 text-slate-600 hover:text-blue-600" data-tab="finance">Finance & Requests</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto"></div>
        </div>
    </div>
    
    <!-- Trip Details Modal -->
    <div id="trip-details-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl border border-slate-200 flex flex-col h-[90vh]">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-800 text-white rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold">Trip Details</h3>
                    <p class="text-xs text-slate-300 font-mono" id="td-token-header"></p>
                </div>
                <button onclick="closeModal('trip-details-modal')" class="text-white hover:text-red-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                <div class="w-full md:w-1/3 p-4 overflow-y-auto border-r border-slate-100 space-y-4 bg-slate-50">
                    <div class="bg-white p-3 rounded border shadow-sm"><p class="text-xs text-slate-400 font-bold mb-1">STATUS</p><span id="td-status" class="px-2 py-1 rounded text-xs font-bold">-</span></div>
                     <div class="bg-white p-3 rounded border shadow-sm"><p class="text-xs text-slate-400 font-bold mb-1">FARE</p><span id="td-fare" class="text-xl font-bold text-green-600">-</span></div>
                    <div class="bg-white p-3 rounded border shadow-sm"><p class="text-xs text-slate-400 font-bold mb-1">DRIVER</p><p class="font-bold text-slate-800" id="td-driver">-</p><p class="text-xs text-slate-500" id="td-car">-</p></div>
                     <div class="bg-white p-3 rounded border shadow-sm"><p class="text-xs text-slate-400 font-bold mb-1">PASSENGER</p><p class="font-bold text-slate-800" id="td-passenger">-</p><p class="text-xs text-slate-500" id="td-passenger-phone">-</p></div>
                     <div class="bg-white p-3 rounded border shadow-sm"><p class="text-xs text-slate-400 font-bold mb-1">ROUTE</p><div class="text-xs space-y-2"><div><span class="text-green-600 font-bold">A</span> <span id="td-pickup">-</span></div><div><span class="text-red-500 font-bold">B</span> <span id="td-dropoff">-</span></div></div></div>
                </div>
                <div class="w-full md:w-2/3 relative bg-slate-200"><div id="trip-map" class="absolute inset-0 z-10"></div></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, onValue, set, get, update, remove, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB7zSpZMYgS2SChtyFrUvvp0txPutecF3g", authDomain: "zenstride.firebaseapp.com", databaseURL: "https://zenstride-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "zenstride", storageBucket: "zenstride.appspot.com", messagingSenderId: "588697035765", appId: "1:588697035765:web:9411ea5aa9588ceb7d36bc" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let map, adminMarker, measureControl, tripMap, tripRouteControl, dispatchMap, dispatchRouteControl;
        let measurePoints = [];
        let isMeasuring = false;
        let currentDriverId = null;
        let driversCache = {};
        let transactionsCache = {};
        let globalAllTrips = []; 
        let pickMode = null;
        let dispPickup = null;
        let dispDropoff = null;
        let currentFare = 0;
        let currentDist = 0;
        
        const dom = {
            loginScreen: document.getElementById('login-screen'),
            dashboard: document.getElementById('dashboard'),
            sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('sidebar-overlay'),
            measureInfo: document.getElementById('measure-info'),
            mapToast: document.getElementById('map-toast'),
            mapCenterPin: document.getElementById('map-center-pin'),
            pinImage: document.getElementById('pin-image'),
            confirmPickBtn: document.getElementById('confirm-pick-btn'),
            dispatchRecenterBtn: document.getElementById('dispatch-recenter-btn')
        };
        
        function showAdminNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/3063/3063823.png' });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                dom.loginScreen.classList.add('hidden');
                dom.dashboard.classList.remove('hidden');
                initData();
                initMap();
                initAds();
                if (Notification.permission !== "granted") Notification.requestPermission();
            } else {
                dom.loginScreen.classList.remove('hidden');
                dom.dashboard.classList.add('hidden');
            }
        });

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
            .catch(e => { document.getElementById('login-error').innerText = e.message; document.getElementById('login-error').classList.remove('hidden'); });
        };
        document.getElementById('logout-button').onclick = () => signOut(auth);

        document.querySelectorAll('.nav-link').forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                const viewId = link.getAttribute('href').substring(1);
                document.getElementById(viewId).classList.remove('hidden');
                dom.sidebar.classList.remove('open'); dom.overlay.classList.add('hidden');
                
                // FIX: Force map resize when switching to map/dispatch views
                if(viewId === 'map-view' && map) setTimeout(() => map.invalidateSize(), 200);
                if(viewId === 'dispatch-view') setTimeout(() => initDispatchMap(), 200);
            };
        });
        document.getElementById('mobile-menu-btn').onclick = () => { dom.sidebar.classList.add('open'); dom.overlay.classList.remove('hidden'); };
        dom.overlay.onclick = () => { dom.sidebar.classList.remove('open'); dom.overlay.classList.add('hidden'); };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // ... [Rest of the initialization and data fetching logic remains same] ...
        function initData() {
            onValue(ref(db, 'drivers'), snap => {
                driversCache = snap.val() || {};
                document.getElementById('stat-drivers').innerText = Object.keys(driversCache).length;
                renderDrivers(driversCache);
            });
            onValue(ref(db, 'driverLocations'), snap => {
                const locs = snap.val() || {};
                document.getElementById('stat-online').innerText = Object.keys(locs).length;
                updateMapMarkers(locs);
            });
            
            let activeTripsList = [];
            let completedTripsList = [];
            
            onValue(ref(db, 'trips'), snap => {
                const trips = snap.val() || {};
                activeTripsList = Object.values(trips);
                document.getElementById('stat-trips').innerText = activeTripsList.filter(t => ['accepted','at_pickup','to_dropoff'].includes(t.status)).length;
                updateTripsTable(activeTripsList, completedTripsList);
            });
            
             onValue(ref(db, 'completedTrips'), snap => {
                let totalCommission = 0;
                completedTripsList = [];
                if(snap.exists()) {
                    Object.entries(snap.val()).forEach(([driverId, driverTrips]) => {
                        Object.entries(driverTrips).forEach(([tripId, t]) => {
                             const comm = t.commissionAmount || 0; 
                             totalCommission += comm;
                             completedTripsList.push({ ...t, status: 'completed', id: tripId, driverId: driverId });
                        });
                    });
                }
                document.getElementById('stat-revenue').innerText = `${totalCommission.toLocaleString()} Ks`;
                updateTripsTable(activeTripsList, completedTripsList);
            });
            
            let initialLoad = true;
            onValue(ref(db, 'transactions'), snap => {
                transactionsCache = snap.val() || {};
                let pendingCount = 0;
                let newPending = false;
                Object.values(transactionsCache).forEach(driverTxs => {
                    Object.values(driverTxs).forEach(tx => {
                        if(tx.status === 'pending' && tx.type === 'topup') {
                            pendingCount++;
                            if (!initialLoad) newPending = true; 
                        }
                    });
                });
                
                if (newPending) {
                    showAdminNotification("New Top-up Request", "Driver has requested a top-up.");
                }

                const badge = document.getElementById('drivers-badge');
                if(pendingCount > 0) {
                    badge.innerText = pendingCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
                renderDrivers(driversCache);
                initialLoad = false;
            });

            // Settings Load
            onValue(ref(db, 'settings/fees'), snap => {
                const fees = snap.val() || { commissionRate: 14, platformFee: 100, baseFare: 1500, pricePerKm: 500 };
                document.getElementById('commission-input').value = fees.commissionRate;
                document.getElementById('platform-fee-input').value = fees.platformFee;
                document.getElementById('base-fare-input').value = fees.baseFare || 1500;
                document.getElementById('price-per-km-input').value = fees.pricePerKm || 500;
            });
            
            onValue(ref(db, 'settings/contact_info'), snap => {
                if(snap.exists()) {
                    const data = snap.val();
                    const phones = data.passengerPhones || [];
                    document.getElementById('contact-phone-1').value = phones[0] || '';
                    document.getElementById('contact-phone-2').value = phones[1] || '';
                    document.getElementById('pay-kpay').value = data.kpay || '';
                    document.getElementById('pay-wave').value = data.wave || '';
                }
            });

            // Branding Load
            onValue(ref(db, 'settings/branding'), snap => {
                if(snap.exists()) {
                    const b = snap.val();
                    if(b.driverLoadingLogo) {
                        const img = document.getElementById('preview-driver-loading-logo');
                        img.src = b.driverLoadingLogo; img.classList.remove('hidden');
                    }
                    if(b.passengerLoadingLogo) {
                        const img = document.getElementById('preview-passenger-loading-logo');
                        img.src = b.passengerLoadingLogo; img.classList.remove('hidden');
                    }
                    if(b.homeLogo) {
                        const img = document.getElementById('preview-home-logo');
                        img.src = b.homeLogo; img.classList.remove('hidden');
                    }
                }
            });
        }
        
        // ... [Helper functions for updateTripsTable, renderTrips etc.] ...
        function updateTripsTable(active, completed) {
            globalAllTrips = [
                ...active.map(t => ({...t, _sortTime: t.createdAt})),
                ...completed.map(t => ({...t, _sortTime: t.completedAt}))
            ];
            filterAndRenderTrips(document.getElementById('trip-search-input').value);
        }
        
        document.getElementById('trip-search-input').addEventListener('input', (e) => {
            filterAndRenderTrips(e.target.value);
        });
        
        function filterAndRenderTrips(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            const filtered = globalAllTrips.filter(t => {
                return (t.token && t.token.toLowerCase().includes(term)) || 
                       (t.id && t.id.toLowerCase().includes(term));
            });
            renderTrips(filtered);
        }

        document.getElementById('settings-form').onsubmit = async (e) => {
            e.preventDefault();
            const comm = parseInt(document.getElementById('commission-input').value);
            const fee = parseInt(document.getElementById('platform-fee-input').value);
            const base = parseInt(document.getElementById('base-fare-input').value);
            const perKm = parseInt(document.getElementById('price-per-km-input').value);
            
            await update(ref(db, 'settings/fees'), { commissionRate: comm, platformFee: fee, baseFare: base, pricePerKm: perKm });
            alert('Pricing Saved!');
        };
        
        document.getElementById('contact-settings-form').onsubmit = async (e) => {
            e.preventDefault();
            const p1 = document.getElementById('contact-phone-1').value;
            const p2 = document.getElementById('contact-phone-2').value;
            const kpay = document.getElementById('pay-kpay').value;
            const wave = document.getElementById('pay-wave').value;
            
            await set(ref(db, 'settings/contact_info'), {
                passengerPhones: [p1, p2].filter(Boolean),
                kpay: kpay,
                wave: wave
            });
            alert('Contact & Payment Info Saved!');
        }

        document.getElementById('branding-form').onsubmit = async (e) => {
            e.preventDefault();
            const dLoadingInput = document.getElementById('driver-loading-logo-input');
            const pLoadingInput = document.getElementById('passenger-loading-logo-input');
            const homeInput = document.getElementById('home-logo-input');
            
            const processFile = (file) => new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });

            const updates = {};
            if(dLoadingInput.files[0]) {
                if(dLoadingInput.files[0].size > 500*1024) return alert("Driver Logo too large (>500KB)");
                updates.driverLoadingLogo = await processFile(dLoadingInput.files[0]);
            }
            if(pLoadingInput.files[0]) {
                if(pLoadingInput.files[0].size > 500*1024) return alert("Passenger Logo too large (>500KB)");
                updates.passengerLoadingLogo = await processFile(pLoadingInput.files[0]);
            }
            if(homeInput.files[0]) {
                if(homeInput.files[0].size > 500*1024) return alert("Home Logo too large (>500KB)");
                updates.homeLogo = await processFile(homeInput.files[0]);
            }

            if(Object.keys(updates).length > 0) {
                await update(ref(db, 'settings/branding'), updates);
                alert("Branding Updated!");
            }
        };

        function renderDrivers(drivers) {
            const tbody = document.getElementById('drivers-table'); tbody.innerHTML = '';
            Object.entries(drivers).forEach(([uid, d]) => {
                const isBanned = d.bannedUntil && d.bannedUntil > Date.now();
                let hasPending = false;
                if (transactionsCache[uid]) {
                    hasPending = Object.values(transactionsCache[uid]).some(tx => tx.status === 'pending' && tx.type === 'topup');
                }
                const tr = document.createElement('tr');
                tr.className = `border-b border-slate-100 hover:bg-slate-50 ${isBanned ? 'bg-red-50' : ''}`;
                tr.innerHTML = `
                    <td class="p-4 font-bold text-slate-800">${d.name} ${hasPending ? '<span class="driver-pending-dot" title="Pending Top-up"></span>' : ''}</td>
                    <td class="p-4 text-slate-500 font-mono text-xs">${d.nrc || 'N/A'}</td>
                    <td class="p-4 text-slate-500">${d.carModel} <span class="text-blue-600 font-mono text-xs">${d.carPlate}</span></td>
                    <td class="p-4">${isBanned ? '<span class="text-red-600 bg-red-100 px-2 py-1 rounded text-xs font-bold">BANNED</span>' : (d.isOnline ? '<span class="text-emerald-600 bg-emerald-100 px-2 py-1 rounded text-xs">Online</span>' : '<span class="text-slate-500 bg-slate-100 px-2 py-1 rounded text-xs">Offline</span>')}</td>
                    <td class="p-4 text-right"><button class="text-blue-600 hover:underline font-semibold" onclick="openDriverDetails('${uid}')">Manage</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderTrips(tripsList) {
            const tbody = document.getElementById('trips-list-table'); tbody.innerHTML = '';
            tripsList.sort((a,b) => b._sortTime - a._sortTime).forEach(t => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-100 text-slate-600 hover:bg-slate-50 cursor-pointer';
                const statusColor = t.status === 'completed' ? 'text-emerald-500' : (t.status === 'cancelled' ? 'text-red-500' : 'text-amber-500');
                tr.innerHTML = `
                    <td class="p-4 font-mono font-bold text-blue-600" onclick="openTripDetails(this.parentElement.dataset.trip)"><span class="bg-blue-50 px-2 py-1 rounded">${t.token || 'N/A'}</span></td>
                    <td class="p-4" onclick="openTripDetails(this.parentElement.dataset.trip)">${new Date(t._sortTime).toLocaleTimeString()}</td>
                    <td class="p-4 max-w-xs truncate" onclick="openTripDetails(this.parentElement.dataset.trip)">${t.pickupAddress ? t.pickupAddress.split(',')[0] : '...'} -> ${t.dropoffAddress ? t.dropoffAddress.split(',')[0] : '...'}</td>
                    <td class="p-4 font-mono font-bold text-slate-800" onclick="openTripDetails(this.parentElement.dataset.trip)">${t.fare}</td>
                    <td class="p-4 font-bold ${statusColor}" onclick="openTripDetails(this.parentElement.dataset.trip)">${t.status}</td>
                    <td class="p-4 text-right"><button class="text-red-400 hover:text-red-600 p-2" onclick="deleteTrip('${t.id}', '${t.driverId}')"></button></td>
                `;
                tr.dataset.trip = JSON.stringify(t);
                const btn = tr.querySelector('button');
                btn.onclick = (e) => { e.stopPropagation(); deleteTrip(t.id, t.driverId); };
                tbody.appendChild(tr);
            });
        }
        
        window.deleteTrip = async (tripId, driverId) => {
            if(!confirm("Are you sure?")) return;
            await remove(ref(db, `trips/${tripId}`));
            if(driverId) await remove(ref(db, `completedTrips/${driverId}/${tripId}`));
        };
        
        window.openTripDetails = async (tripJson) => {
            const trip = typeof tripJson === 'string' ? JSON.parse(tripJson) : tripJson;
            document.getElementById('trip-details-modal').classList.remove('hidden');
            document.getElementById('td-token-header').innerText = `Token: ${trip.token || 'N/A'}`;
            document.getElementById('td-status').innerText = trip.status.toUpperCase();
            document.getElementById('td-fare').innerText = `${trip.fare.toLocaleString()} Ks`;
            document.getElementById('td-pickup').innerText = trip.pickupAddress || 'N/A';
            document.getElementById('td-dropoff').innerText = trip.dropoffAddress || 'N/A';
            
            // Re-fetch driver and passenger to ensure fresh data
            if(trip.driverId) {
                const dSnap = await get(ref(db, `drivers/${trip.driverId}`));
                if(dSnap.exists()) {
                    const d = dSnap.val();
                    document.getElementById('td-driver').innerText = d.name;
                    document.getElementById('td-car').innerText = `${d.carModel} - ${d.carPlate}`;
                } else {
                    document.getElementById('td-driver').innerText = 'Driver not found';
                    document.getElementById('td-car').innerText = '-';
                }
            } else {
                document.getElementById('td-driver').innerText = 'Pending';
                document.getElementById('td-car').innerText = '-';
            }

            if(trip.passengerId) {
                const pSnap = await get(ref(db, `passengers/${trip.passengerId}`));
                if(pSnap.exists()) {
                    const p = pSnap.val();
                    document.getElementById('td-passenger').innerText = p.name || 'Unknown';
                    document.getElementById('td-passenger-phone').innerText = p.phone || '-';
                }
            } else if (trip.passengerPhone) {
                document.getElementById('td-passenger').innerText = "Manual Booking";
                document.getElementById('td-passenger-phone').innerText = trip.passengerPhone;
            }

            setTimeout(() => {
                if(!tripMap) {
                    tripMap = L.map('trip-map', { zoomControl: false });
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(tripMap);
                }
                // FIX: Invalidate size to ensure it renders correctly in modal
                tripMap.invalidateSize();
                
                tripMap.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        tripMap.removeLayer(layer);
                    }
                });
                
                if (trip.pickup && trip.dropoff) {
                    const pickup = [trip.pickup.lat, trip.pickup.lng];
                    const dropoff = [trip.dropoff.lat, trip.dropoff.lng];
                    
                    L.marker(pickup).addTo(tripMap).bindPopup("Pickup").openPopup();
                    L.marker(dropoff).addTo(tripMap).bindPopup("Dropoff");
                    
                    if(tripRouteControl) tripMap.removeControl(tripRouteControl);
                    
                    tripRouteControl = L.Routing.control({
                        waypoints: [ L.latLng(pickup), L.latLng(dropoff) ],
                        createMarker: () => null,
                        addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true, show: false,
                        lineOptions: { styles: [{color: '#3b82f6', opacity: 0.8, weight: 6}] }
                    }).addTo(tripMap);
                }
            }, 200);
        };

        // ... [openDriverDetails, renderModalContent, etc. remain the same] ...
        window.openDriverDetails = async (uid) => {
            currentDriverId = uid;
            const d = driversCache[uid];
            if(!d) return;
            document.getElementById('details-modal').classList.remove('hidden');
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(t => t.onclick = () => {
                tabs.forEach(x => x.classList.remove('active'));
                t.classList.add('active');
                renderModalContent(t.dataset.tab, d);
            });
            tabs[0].click();
        };

        async function renderModalContent(tab, driver) {
            const container = document.getElementById('modal-body');
            if(tab === 'info') {
                const isBanned = driver.bannedUntil && driver.bannedUntil > Date.now();
                container.innerHTML = `
                    <div class="space-y-4 text-slate-800">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl font-bold border-2 border-white shadow overflow-hidden">${driver.profilePic ? `<img src="${driver.profilePic}" class="w-full h-full object-cover">` : driver.name.charAt(0)}</div>
                            <div><h2 class="text-2xl font-bold">${driver.name}</h2><p class="text-slate-500">${driver.email}</p></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-3 rounded border"><p class="text-xs text-slate-400 uppercase font-bold">Phone</p><p class="font-medium">${driver.phone}</p></div>
                            <div class="bg-slate-50 p-3 rounded border"><p class="text-xs text-slate-400 uppercase font-bold">NRC</p><p class="font-medium">${driver.nrc || 'N/A'}</p></div>
                            <div class="bg-slate-50 p-3 rounded border col-span-2"><p class="text-xs text-slate-400 uppercase font-bold">Car</p><p class="font-medium">${driver.carModel} (${driver.carPlate})</p></div>
                            <div class="bg-slate-50 p-3 rounded border col-span-2"><p class="text-xs text-slate-400 uppercase font-bold">Password</p><p class="font-mono text-red-500 font-bold">${driver.password || 'Hidden'}</p></div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-xl border border-red-200 mt-4">
                            <h4 class="font-bold text-red-700 mb-2">Ban Management</h4>
                            ${isBanned ? `<p class="text-red-600 font-bold mb-2"> Banned until: ${new Date(driver.bannedUntil).toLocaleDateString()}</p><button onclick="unbanDriver('${currentDriverId}')" class="bg-white text-red-600 border border-red-300 px-3 py-1 rounded text-xs font-bold hover:bg-red-50">Unban Now</button>` : ''}
                            <div class="mt-3 flex gap-2 mt-1"><input type="date" id="ban-date" class="border border-red-300 rounded p-2 text-sm"><button onclick="banDriver('${currentDriverId}')" class="bg-red-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-red-700">Set Ban</button></div>
                        </div>
                        <button onclick="removeDriver('${currentDriverId}')" class="w-full mt-6 bg-slate-100 text-slate-600 border border-slate-200 py-3 rounded-lg font-bold hover:bg-slate-200 transition">PERMANENTLY DELETE RECORD</button>
                    </div>
                `;
            } else {
                container.innerHTML = '<p class="text-slate-400 text-center">Loading Finance Data...</p>';
                const historySnap = await get(ref(db, `completedTrips/${currentDriverId}`));
                const transactionsSnap = await get(ref(db, `transactions/${currentDriverId}`));
                const settingsSnap = await get(ref(db, 'settings/fees'));
                const fees = settingsSnap.val() || { commissionRate: 14, platformFee: 100 };
                
                let totalDeductions = 0, totalTopups = 0;
                if(historySnap.exists()) Object.values(historySnap.val()).forEach(t => totalDeductions += (t.commissionAmount || (fees.platformFee + Math.round((t.fare - fees.platformFee) * (fees.commissionRate/100)))));
                let txList = [];
                if(transactionsSnap.exists()) {
                    txList = Object.keys(transactionsSnap.val()).map(key => ({ id: key, ...transactionsSnap.val()[key] }));
                    txList.forEach(tx => { if(tx.status === 'approved') { if(tx.type === 'topup' || tx.type === 'credit') totalTopups += tx.amount; else totalTopups -= tx.amount; } });
                }
                txList.sort((a,b) => b.date - a.date);
                const balance = totalTopups - totalDeductions;

                container.innerHTML = `
                    <div class="bg-gradient-to-r from-blue-600 to-blue-500 p-6 rounded-xl mb-6 flex justify-between items-center text-white shadow-lg"><div><p class="text-xs text-blue-100 uppercase font-bold tracking-wide">Wallet Balance</p><h2 class="text-3xl font-extrabold">${balance.toLocaleString()} Ks</h2></div></div>
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6"><h4 class="font-bold text-slate-700 text-xs uppercase mb-2">Manual Adjustment</h4><div class="flex gap-2 mb-2"><select id="adj-type" class="bg-white border p-2 rounded text-xs"><option value="credit">Credit (+)</option><option value="debit">Debit (-)</option></select><input id="adj-amount" type="number" placeholder="Amount" class="bg-white border p-2 rounded text-xs w-full"></div><input id="adj-reason" type="text" placeholder="Reason" class="bg-white border p-2 rounded text-xs w-full mb-2"><button onclick="manualAdjust('${currentDriverId}')" class="w-full bg-slate-800 text-white text-xs font-bold py-2 rounded">Apply Adjustment</button></div>
                    <h3 class="font-bold text-slate-800 mb-2 border-b pb-2">Transactions</h3>
                    <div class="space-y-3 max-h-80 overflow-y-auto pr-2 custom-scrollbar">${txList.length ? txList.map(tx => `<div class="flex justify-between items-center p-3 ${tx.status === 'pending' ? 'bg-yellow-50' : 'bg-slate-50'} border rounded-lg"><div><p class="font-bold text-slate-700">${tx.type}</p><p class="text-xs text-slate-400">${new Date(tx.date).toLocaleDateString()}</p>${tx.status === 'pending' ? `<p class="text-xs font-mono">${tx.method} ${tx.txId}</p>` : ''}</div><div class="text-right"><p class="font-bold ${tx.type.includes('withdraw') || tx.type.includes('debit') ? 'text-red-500' : 'text-green-600'}">${tx.amount.toLocaleString()}</p>${tx.status === 'pending' ? `<div class="flex gap-2 mt-1"><button onclick="handleTx('${currentDriverId}', '${tx.id}', 'rejected')" class="text-xs text-red-500 font-bold">Reject</button><button onclick="handleTx('${currentDriverId}', '${tx.id}', 'approved')" class="text-xs text-green-600 font-bold">Approve</button></div>` : ''}</div></div>`).join('') : '<p class="text-center text-slate-400">No Data</p>'}</div>
                `;
            }
        }

        window.banDriver = async (uid) => {
            const dateVal = document.getElementById('ban-date').value;
            if(!dateVal) return alert("Select a date");
            await update(ref(db, `drivers/${uid}`), { bannedUntil: new Date(dateVal).getTime(), isOnline: false });
            renderModalContent('info', driversCache[uid]); alert("Banned");
        };
        window.unbanDriver = async (uid) => { await update(ref(db, `drivers/${uid}`), { bannedUntil: null }); renderModalContent('info', driversCache[uid]); };
        window.handleTx = async (driverId, txId, status) => { await update(ref(db, `transactions/${driverId}/${txId}`), { status }); renderModalContent('finance', driversCache[driverId]); };
        window.removeDriver = async (uid) => { if(confirm("Delete?")) { await remove(ref(db, `drivers/${uid}`)); await remove(ref(db, `driverLocations/${uid}`)); closeModal('details-modal'); } };
        window.manualAdjust = async (uid) => { 
            const amt = parseInt(document.getElementById('adj-amount').value);
            if(!amt) return;
            await push(ref(db, `transactions/${uid}`), { amount: amt, date: serverTimestamp(), type: document.getElementById('adj-type').value, reason: document.getElementById('adj-reason').value, status: 'approved' });
            renderModalContent('finance', driversCache[uid]);
        };

        function initAds() {
            onValue(ref(db, 'ads'), s => {
                const b = document.getElementById('ads-table-body'); b.innerHTML = '';
                if(s.exists()) Object.entries(s.val()).forEach(([id, ad]) => {
                    b.innerHTML += `<tr class="border-b"><td class="p-3"><img src="${ad.imageUrl}" class="w-16 h-10 object-cover"></td><td class="p-3">${ad.title}</td><td class="p-3">${ad.position}</td><td class="p-3 text-right"><button onclick="deleteAd('${id}')" class="text-red-500 font-bold text-xs border p-1 rounded">Delete</button></td></tr>`;
                });
            });
        }
        window.deleteAd = async (id) => { if(confirm("Delete?")) await remove(ref(db, `ads/${id}`)); };
        document.getElementById('create-ad-form').onsubmit = async (e) => {
            e.preventDefault();
            const title = document.getElementById('ad-title').value;
            const pos = document.getElementById('ad-position').value;
            const files = document.getElementById('ad-image').files;
            if(files.length) {
                for(let i=0; i<files.length; i++) {
                    const reader = new FileReader();
                    reader.onload = async () => await push(ref(db, 'ads'), { title: `${title} ${i+1}`, imageUrl: reader.result, position: pos, createdAt: serverTimestamp() });
                    reader.readAsDataURL(files[i]);
                }
                alert("Published"); document.getElementById('create-ad-form').reset();
            }
        };

        function initMap() { if(!map) { map = L.map('admin-map', {zoomControl:false}).setView([16.8,96.1],13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); } }
        document.getElementById('recenter-btn').onclick = () => map.setView([16.8,96.1],13); 
        
        // Dispatch Mode Logic
        window.initDispatchMap = () => {
             if(dispatchMap) { setTimeout(() => dispatchMap.invalidateSize(), 200); return; }
             dispatchMap = L.map('dispatch-map', { zoomControl: false }).setView([16.8409, 96.1735], 13);
             L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(dispatchMap);
             if(navigator.geolocation) {
                 navigator.geolocation.watchPosition(pos => {
                     const latlng = [pos.coords.latitude, pos.coords.longitude];
                     if(adminMarker) adminMarker.setLatLng(latlng);
                     L.circleMarker(latlng, { radius: 6, color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(dispatchMap);
                     dom.dispatchRecenterBtn.onclick = () => dispatchMap.setView(latlng, 15);
                 });
             }
        }
        
        window.setPickMode = (mode) => {
            pickMode = mode;
            document.getElementById('map-toast').innerText = `Move map to set ${mode.toUpperCase()}`;
            document.getElementById('map-toast').classList.remove('hidden');
            dom.mapCenterPin.classList.remove('hidden');
            dom.confirmPickBtn.classList.remove('hidden');
            if(mode === 'pickup') {
                dom.pinImage.src = BLUE_PIN_SVG;
                dom.confirmPickBtn.className = dom.confirmPickBtn.className.replace('bg-red-800', 'bg-blue-800').replace('hover:bg-red-700', 'hover:bg-blue-700');
            } else {
                dom.pinImage.src = RED_PIN_SVG;
                dom.confirmPickBtn.className = dom.confirmPickBtn.className.replace('bg-blue-800', 'bg-red-800').replace('hover:bg-blue-700', 'hover:bg-red-700');
            }
        }
        
        window.confirmDispatchPick = async () => {
            const center = dispatchMap.getCenter();
            document.getElementById('map-toast').innerText = "Getting Address...";
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}`);
                const data = await response.json();
                const addr = data.display_name.split(',')[0];
                const loc = { lat: center.lat, lng: center.lng, address: data.display_name };
                if(pickMode === 'pickup') { dispPickup = loc; document.getElementById('disp-pickup-addr').innerText = addr; } else { dispDropoff = loc; document.getElementById('disp-dropoff-addr').innerText = addr; }
                pickMode = null; document.getElementById('map-toast').classList.add('hidden'); dom.mapCenterPin.classList.add('hidden'); dom.confirmPickBtn.classList.add('hidden');
                if(dispPickup && dispDropoff) calcDispatchRoute();
            } catch(err) { document.getElementById('map-toast').innerText = "Error getting address"; }
        };
        
        window.resetDispatchMap = () => {
            dispPickup = null; dispDropoff = null;
            if(dispatchRouteControl) dispatchMap.removeControl(dispatchRouteControl);
            document.getElementById('disp-pickup-addr').innerText = "Select on Map";
            document.getElementById('disp-dropoff-addr').innerText = "Select on Map";
            document.getElementById('disp-fare-info').classList.add('hidden');
            document.getElementById('btn-dispatch').disabled = true;
        };
        
        function calcDispatchRoute() {
            if(dispatchRouteControl) dispatchMap.removeControl(dispatchRouteControl);
            dispatchRouteControl = L.Routing.control({
                waypoints: [ L.latLng(dispPickup.lat, dispPickup.lng), L.latLng(dispDropoff.lat, dispDropoff.lng) ],
                createMarker: () => null, show: false, addWaypoints: false, fitSelectedRoutes: true,
                lineOptions: { styles: [{color: '#10b981', opacity: 0.8, weight: 6}] }
            }).addTo(dispatchMap);
            dispatchRouteControl.on('routesfound', (e) => {
                const r = e.routes[0];
                currentDist = (r.summary.totalDistance / 1000).toFixed(1);
                const fees = { baseFare: parseInt(document.getElementById('base-fare-input').value), pricePerKm: parseInt(document.getElementById('price-per-km-input').value) };
                currentFare = Math.max(2000, Math.round((fees.baseFare + parseFloat(currentDist) * fees.pricePerKm)/100)*100);
                document.getElementById('disp-fare-info').classList.remove('hidden');
                document.getElementById('disp-dist').innerText = currentDist;
                document.getElementById('disp-fare').innerText = currentFare.toLocaleString();
                document.getElementById('btn-dispatch').disabled = false;
            });
        }
        
        window.createManualTrip = async () => {
            const phone = document.getElementById('disp-phone').value;
            if(!phone) return alert("Passenger Phone Required");
            if(!dispPickup || !dispDropoff) return alert("Select locations");
            const snapshot = await get(ref(db, 'driverLocations'));
            const drivers = [];
            if(snapshot.exists()) { snapshot.forEach(child => { const d = child.val(); if(d.isAvailable) { const dist = L.latLng(dispPickup).distanceTo([d.lat, d.lng]); drivers.push({ id: child.key, dist }); } }); }
            drivers.sort((a,b) => a.dist - b.dist);
            if(drivers.length === 0) return alert("No available drivers nearby");
            const tripId = `trip_manual_${Date.now()}`;
            const token = `T-${Math.floor(1000 + Math.random() * 9000)}`;
            const trip = { id: tripId, token, passengerId: 'manual_dispatch', passengerPhone: phone, pickup: dispPickup, dropoff: dispDropoff, pickupAddress: dispPickup.address, dropoffAddress: dispDropoff.address, fare: currentFare, status: 'pending', createdAt: serverTimestamp(), vehicleType: 'Normal', paymentMethod: 'Cash', requestTime: Date.now(), requestedDriverId: drivers[0].id, driverQueue: drivers.map(d => d.id), declinedDriverIds: [] };
            await set(ref(db, `trips/${tripId}`), trip);
            alert(`Trip Dispatched! Token: ${token}`);
            resetDispatchMap();
        }

        document.getElementById('add-driver-btn').onclick = () => document.getElementById('add-driver-modal').classList.remove('hidden');
        document.getElementById('add-driver-form').onsubmit = async (e) => {
            e.preventDefault();
            const d = Object.fromEntries(new FormData(e.target));
            try {
                const sa = initializeApp(firebaseConfig, "SA"); const sath = getAuth(sa);
                const uc = await createUserWithEmailAndPassword(sath, d.email, d.password);
                await set(ref(db, `drivers/${uc.user.uid}`), { ...d, isOnline: false, createdAt: new Date().toISOString() });
                await signOut(sath); closeModal('add-driver-modal'); alert("Created");
            } catch(e) { alert(e.message); }
        };

    </script>
</body>
</html>
