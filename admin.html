<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyapay Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --bg-dark: #0f172a; --bg-medium: #1e293b; --bg-light: #334155;
            --accent: #10b981; --accent-hover: #059669;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8;
        }
        body { background-color: var(--bg-dark); color: var(--text-primary); font-family: 'Inter', sans-serif; }
        .sidebar { background-color: var(--bg-medium); width: 16rem; transition: transform 0.3s ease; }
        .card { background-color: var(--bg-medium); border: 1px solid var(--bg-light); }
        .btn-primary { background-color: var(--accent); color: #0f172a; font-weight: 600; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .modal-backdrop { background-color: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        
        /* Map Customization */
        .leaflet-container .leaflet-control-attribution { display: none; }
        .leaflet-tile { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .leaflet-popup-content-wrapper { background: #1e293b; color: #fff; border-radius: 8px; }
        .leaflet-popup-tip { background: #1e293b; }
        .leaflet-routing-container { display: none; }

        .tab-btn.active { border-bottom: 2px solid var(--accent); color: var(--accent); }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--bg-light); border-radius: 4px; }
    </style>
</head>
<body class="text-sm h-screen overflow-hidden flex flex-col">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900">
        <div class="w-full max-w-sm p-8 space-y-6 bg-slate-800 rounded-2xl shadow-2xl border border-slate-700">
            <div class="text-center">
                <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-500 mb-2">Pyapay</h1>
                <p class="text-slate-400 font-medium">Admin Control Center</p>
            </div>
            <form id="login-form" class="space-y-4 mt-6">
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Email</label>
                    <input id="email" type="email" required class="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Password</label>
                    <input id="password" type="password" required class="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <p id="login-error" class="text-sm text-red-400 text-center hidden bg-red-900/20 py-2 rounded"></p>
                <button type="submit" class="w-full py-3 rounded-lg btn-primary shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40 transition-all">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="dashboard" class="hidden flex h-full relative">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar flex flex-col border-r border-slate-700 hidden md:flex">
            <div class="h-16 flex items-center px-6 border-b border-slate-700 bg-slate-800">
                <div class="w-8 h-8 rounded-lg bg-emerald-500 flex items-center justify-center text-slate-900 font-bold text-lg mr-3">P</div>
                <span class="text-xl font-bold text-white tracking-tight">Pyapay Admin</span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                <a href="#dashboard-view" class="nav-link active flex items-center gap-3 px-6 py-3 text-slate-300 hover:bg-slate-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>Dashboard</a>
                <a href="#drivers-view" class="nav-link flex items-center gap-3 px-6 py-3 text-slate-300 hover:bg-slate-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>Drivers List</a>
                <a href="#finance-view" class="nav-link flex items-center gap-3 px-6 py-3 text-slate-300 hover:bg-slate-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Wallet & Finance</a>
                <a href="#map-view" class="nav-link flex items-center gap-3 px-6 py-3 text-slate-300 hover:bg-slate-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>Live Map & Tools</a>
            </nav>
            <div class="p-4 border-t border-slate-700 bg-slate-800">
                <button id="logout-button" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white rounded-lg transition-colors font-semibold">Sign Out</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 flex flex-col min-w-0 bg-slate-900">
            <header class="h-16 flex items-center justify-between px-6 bg-slate-800/80 backdrop-blur border-b border-slate-700">
                <h2 id="page-title" class="text-xl font-bold text-white">Dashboard Overview</h2>
                <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-700 rounded-full">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span class="text-xs font-semibold text-white">System Active</span>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-6 scroll-smooth">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view-content space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6 rounded-xl shadow-lg border-l-4 border-l-blue-500"><p class="text-slate-400 text-xs font-bold uppercase">Drivers</p><h3 id="stat-drivers" class="text-3xl font-bold text-white mt-1">0</h3></div>
                        <div class="card p-6 rounded-xl shadow-lg border-l-4 border-l-emerald-500"><p class="text-slate-400 text-xs font-bold uppercase">Online</p><h3 id="stat-online" class="text-3xl font-bold text-emerald-400 mt-1">0</h3></div>
                        <div class="card p-6 rounded-xl shadow-lg border-l-4 border-l-amber-500"><p class="text-slate-400 text-xs font-bold uppercase">Trips</p><h3 id="stat-trips" class="text-3xl font-bold text-amber-400 mt-1">0</h3></div>
                        <div class="card p-6 rounded-xl shadow-lg border-l-4 border-l-purple-500"><p class="text-slate-400 text-xs font-bold uppercase">Sys. Balance</p><h3 id="stat-system-balance" class="text-3xl font-bold text-purple-400 mt-1">0</h3></div>
                    </div>
                </div>

                <!-- Drivers List View -->
                <div id="drivers-view" class="view-content hidden space-y-6">
                    <div class="flex justify-between">
                        <input type="text" id="driver-search" placeholder="Search..." class="bg-slate-800 border-slate-700 text-white rounded-lg px-4 py-2">
                        <button onclick="document.getElementById('add-driver-modal').classList.remove('hidden')" class="btn-primary py-2 px-4 rounded-lg">Add Driver</button>
                    </div>
                    <div class="card rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-left text-white"><tbody id="drivers-table" class="divide-y divide-slate-700"></tbody></table>
                    </div>
                </div>

                <!-- Finance View -->
                <div id="finance-view" class="view-content hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                         <div class="card p-4 rounded-xl"><p class="text-xs text-slate-400 uppercase">Driver Wallets Total</p><p id="total-wallet-holdings" class="text-2xl font-bold text-white">0 MMK</p></div>
                         <div class="card p-4 rounded-xl"><p class="text-xs text-slate-400 uppercase">Platform Profit (Est. 14%)</p><p id="platform-profit" class="text-2xl font-bold text-emerald-400">0 MMK</p></div>
                         <div class="card p-4 rounded-xl"><p class="text-xs text-slate-400 uppercase">Transactions Today</p><p id="today-tx-count" class="text-2xl font-bold text-blue-400">0</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card rounded-xl overflow-hidden h-[600px] flex flex-col">
                            <div class="p-4 bg-slate-800 border-b border-slate-700"><h3 class="font-bold text-white">Driver Wallets</h3></div>
                            <div class="overflow-auto flex-1"><table class="w-full text-left text-white"><tbody id="wallet-table" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                         <div class="card rounded-xl overflow-hidden h-[600px] flex flex-col">
                            <div class="p-4 bg-slate-800 border-b border-slate-700"><h3 class="font-bold text-white">Recent Transactions</h3></div>
                            <div class="overflow-auto flex-1"><table class="w-full text-left text-white"><tbody id="transactions-log-table" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- Live Map View -->
                <div id="map-view" class="view-content hidden h-full flex flex-col">
                     <div class="card rounded-xl border-0 overflow-hidden shadow-xl flex-1 relative h-[600px] md:h-full">
                        <div id="admin-map" class="absolute inset-0 z-10 bg-slate-800"></div>
                        <!-- Tools -->
                        <div class="absolute top-4 left-4 z-20 flex flex-col gap-2">
                             <button id="map-recenter-btn" class="bg-slate-900/90 text-white p-2 rounded-lg border border-slate-700 shadow hover:bg-slate-800" title="Recenter Admin"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg></button>
                             <button id="map-measure-btn" class="bg-slate-900/90 text-white p-2 rounded-lg border border-slate-700 shadow hover:bg-slate-800" title="Measure Trip"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg></button>
                        </div>
                        <!-- Measure Result Box -->
                         <div id="measure-info" class="absolute top-4 left-16 z-20 bg-slate-900/95 text-white p-3 rounded-lg border border-emerald-500 shadow-xl hidden w-64">
                            <div class="flex justify-between items-center border-b border-slate-700 pb-1 mb-2"><span class="text-xs font-bold text-emerald-400">MEASUREMENT TOOL</span><button onclick="resetMeasure()" class="text-xs text-red-400">&times;</button></div>
                            <div id="measure-results"></div>
                        </div>
                     </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="add-driver-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-slate-800 rounded-xl w-full max-w-lg border border-slate-700 p-6">
            <h3 class="text-xl font-bold text-white mb-4">Add Driver</h3>
            <form id="add-driver-form" class="space-y-4">
                <input name="name" type="text" placeholder="Name" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white" required>
                <input name="email" type="email" placeholder="Email" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white" required>
                <input name="password" type="password" placeholder="Password" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white" required>
                <input name="phone" type="text" placeholder="Phone" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white" required>
                <input name="carModel" type="text" placeholder="Car Model" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white" required>
                <input name="carPlate" type="text" placeholder="Car Plate" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white" required>
                <input name="address" type="text" placeholder="Address" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white" required>
                <div class="flex justify-end gap-2"><button type="button" onclick="document.getElementById('add-driver-modal').classList.add('hidden')" class="px-4 py-2 text-slate-300">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded">Create</button></div>
            </form>
        </div>
    </div>

    <!-- Topup/Withdraw Modal -->
    <div id="money-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-slate-800 rounded-xl w-full max-w-sm border border-slate-700 p-6">
            <h3 id="money-modal-title" class="text-xl font-bold text-white mb-2">Transaction</h3>
            <form id="money-form" class="space-y-4">
                <input type="hidden" id="money-driver-id"><input type="hidden" id="money-type">
                <input id="money-amount" type="number" placeholder="Amount (MMK)" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white" required>
                <input id="money-note" type="text" placeholder="Note (e.g. KPay ID)" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white" required>
                <div class="flex justify-end gap-2"><button type="button" onclick="document.getElementById('money-modal').classList.add('hidden')" class="px-4 py-2 text-slate-300">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded">Confirm</button></div>
            </form>
        </div>
    </div>

    <!-- Driver Details Modal -->
    <div id="details-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-slate-800 rounded-xl w-full max-w-2xl border border-slate-700 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-700 flex justify-between"><h3 id="details-title" class="text-xl font-bold text-white">Details</h3><button onclick="document.getElementById('details-modal').classList.add('hidden')" class="text-white">&times;</button></div>
            <div class="flex border-b border-slate-700"><button onclick="switchTab('profile')" class="tab-btn active flex-1 py-3 text-slate-300">Profile</button><button onclick="switchTab('finance')" class="tab-btn flex-1 py-3 text-slate-300">History & Finance</button></div>
            <div id="modal-content" class="p-6 overflow-y-auto flex-1"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, onValue, set, get, remove, update, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const config = { apiKey: "AIzaSyB7zSpZMYgS2SChtyFrUvvp0txPutecF3g", authDomain: "zenstride.firebaseapp.com", databaseURL: "https://zenstride-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "zenstride" };
        const app = initializeApp(config); const auth = getAuth(app); const db = getDatabase(app);
        
        let allDrivers = {}, activeDriverId = null, map, adminMarker, measureControl, measureStart, measureEnd;

        // Auth
        onAuthStateChanged(auth, async u => {
            if(u && (await get(ref(db, `admins/${u.uid}`))).exists()) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                initData();
            } else { document.getElementById('login-screen').classList.remove('hidden'); }
        });

        document.getElementById('login-form').onsubmit = e => { e.preventDefault(); signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(alert); };
        document.getElementById('logout-button').onclick = () => signOut(auth);

        // Nav
        document.querySelectorAll('.nav-link').forEach(l => l.onclick = e => {
            e.preventDefault();
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active', 'bg-slate-800'));
            l.classList.add('active', 'bg-slate-800');
            const target = l.getAttribute('href').substring(1);
            document.getElementById(target).classList.remove('hidden');
            if(target === 'map-view') setTimeout(() => { if(!map) initMap(); else map.invalidateSize(); }, 200);
        });

        // Data
        function initData() {
            onValue(ref(db, 'drivers'), s => {
                allDrivers = s.val() || {};
                document.getElementById('stat-drivers').innerText = Object.keys(allDrivers).length;
                renderDrivers(); renderWallet();
                let total = 0; Object.values(allDrivers).forEach(d => total += (d.walletBalance || 0));
                document.getElementById('stat-system-balance').innerText = total.toLocaleString() + ' MMK';
                document.getElementById('total-wallet-holdings').innerText = total.toLocaleString() + ' MMK';
            });
            onValue(ref(db, 'driverLocations'), s => document.getElementById('stat-online').innerText = Object.keys(s.val()||{}).length);
            onValue(ref(db, 'trips'), s => document.getElementById('stat-trips').innerText = Object.values(s.val()||{}).filter(t=>['accepted','at_pickup','to_dropoff'].includes(t.status)).length);
            onValue(ref(db, 'transactions'), s => renderTransactions(s.val()||{}));
            onValue(ref(db, 'completedTrips'), s => {
                 let profit = 0;
                 if(s.exists()) s.forEach(d => d.forEach(t => profit += (t.val().fare || 0) * 0.14));
                 document.getElementById('platform-profit').innerText = Math.round(profit).toLocaleString() + ' MMK';
            });
        }

        function renderDrivers() {
            const tbody = document.getElementById('drivers-table'); tbody.innerHTML = '';
            Object.entries(allDrivers).forEach(([uid, d]) => {
                if(document.getElementById('driver-search').value && !d.name.toLowerCase().includes(document.getElementById('driver-search').value)) return;
                tbody.innerHTML += `<tr class="border-b border-slate-700 hover:bg-slate-800"><td class="p-3"><div class="font-bold">${d.name}</div><div class="text-xs text-slate-500">${d.carPlate}</div></td><td class="p-3">${d.phone}</td><td class="p-3"><span class="px-2 py-0.5 rounded text-xs ${d.isOnline?'bg-emerald-500/20 text-emerald-400':'bg-slate-700 text-slate-400'}">${d.isOnline?'Online':'Offline'}</span></td><td class="p-3 text-right"><button class="text-emerald-400 text-xs font-bold" onclick="window.openDetails('${uid}')">Manage</button></td></tr>`;
            });
        }
        document.getElementById('driver-search').oninput = renderDrivers;

        function renderWallet() {
            const tbody = document.getElementById('wallet-table'); tbody.innerHTML = '';
            Object.entries(allDrivers).forEach(([uid, d]) => {
                 tbody.innerHTML += `<tr class="border-b border-slate-700"><td class="p-3"><div class="font-bold">${d.name}</div><div class="text-xs text-slate-500">${d.phone}</div></td><td class="p-3 font-mono font-bold ${d.walletBalance<1000?'text-red-400':'text-white'}">${(d.walletBalance||0).toLocaleString()}</td><td class="p-3 text-right"><button onclick="window.openMoney('${uid}','credit')" class="bg-emerald-600 px-2 py-1 rounded text-xs mr-1">TopUp</button><button onclick="window.openMoney('${uid}','debit')" class="bg-red-600 px-2 py-1 rounded text-xs">Withdraw</button></td></tr>`;
            });
        }

        function renderTransactions(txs) {
            const tbody = document.getElementById('transactions-log-table'); tbody.innerHTML = '';
            const arr = Object.values(txs).sort((a,b) => b.timestamp - a.timestamp);
            document.getElementById('today-tx-count').innerText = arr.filter(t => new Date(t.timestamp).toDateString() === new Date().toDateString()).length;
            arr.slice(0,50).forEach(t => {
                const driver = allDrivers[t.driverId] ? allDrivers[t.driverId].name : 'Unknown';
                tbody.innerHTML += `<tr class="border-b border-slate-700"><td class="p-3"><div>${driver}</div><div class="text-xs text-slate-500">${new Date(t.timestamp).toLocaleTimeString()}</div></td><td class="p-3"><div class="text-xs font-bold uppercase ${t.type==='credit'?'text-emerald-400':'text-red-400'}">${t.type}</div><div class="text-xs text-slate-400">${t.note}</div></td><td class="p-3 font-mono text-right font-bold">${t.amount.toLocaleString()}</td></tr>`;
            });
        }

        // Add Driver
        document.getElementById('add-driver-form').onsubmit = async e => {
            e.preventDefault();
            const fd = new FormData(e.target); const d = Object.fromEntries(fd);
            try {
                const ta = getAuth(initializeApp(config, `temp-${Date.now()}`));
                const uc = await createUserWithEmailAndPassword(ta, d.email, d.password);
                delete d.password; d.isOnline = false; d.walletBalance = 0;
                await set(ref(db, `drivers/${uc.user.uid}`), d);
                document.getElementById('add-driver-modal').classList.add('hidden'); e.target.reset();
            } catch(err) { alert(err.message); }
        };

        // Money Modal
        window.openMoney = (uid, type) => {
            document.getElementById('money-modal').classList.remove('hidden');
            document.getElementById('money-modal-title').innerText = type === 'credit' ? 'Top Up Wallet' : 'Withdraw / Deduct';
            document.getElementById('money-driver-id').value = uid;
            document.getElementById('money-type').value = type;
            document.getElementById('money-amount').value = '';
        };

        document.getElementById('money-form').onsubmit = async e => {
            e.preventDefault();
            const uid = document.getElementById('money-driver-id').value;
            const type = document.getElementById('money-type').value;
            const amt = parseInt(document.getElementById('money-amount').value);
            const note = document.getElementById('money-note').value;
            const cur = (allDrivers[uid].walletBalance || 0);
            if(type === 'debit' && cur < amt) return alert('Insufficient funds');
            await update(ref(db, `drivers/${uid}`), { walletBalance: type==='credit' ? cur+amt : cur-amt });
            await push(ref(db, 'transactions'), { driverId: uid, amount: amt, type, note, timestamp: serverTimestamp() });
            document.getElementById('money-modal').classList.add('hidden');
        };

        // Details Modal
        window.openDetails = (uid) => {
            activeDriverId = uid;
            document.getElementById('details-modal').classList.remove('hidden');
            document.getElementById('details-title').innerText = allDrivers[uid].name;
            switchTab('profile');
        }
        
        window.switchTab = async (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            const content = document.getElementById('modal-content');
            const d = allDrivers[activeDriverId];
            
            if(tab === 'profile') {
                content.innerHTML = `<div class="space-y-4 text-white"><p><strong>Email:</strong> ${d.email}</p><p><strong>Phone:</strong> ${d.phone}</p><p><strong>Car:</strong> ${d.carModel} (${d.carPlate})</p><p><strong>Address:</strong> ${d.address}</p><button onclick="window.removeDriver('${activeDriverId}')" class="w-full bg-red-600 py-3 rounded font-bold mt-4">BAN / REMOVE DRIVER</button></div>`;
            } else {
                content.innerHTML = '<p class="text-center text-slate-400">Loading...</p>';
                const s = await get(ref(db, `completedTrips/${activeDriverId}`));
                let h = `<div class="mb-4 p-4 bg-slate-700 rounded flex justify-between items-center"><div><span class="text-xs text-slate-400">Balance</span><h2 class="text-2xl font-bold text-white">${(d.walletBalance||0).toLocaleString()}</h2></div><div class="space-x-2"><button onclick="window.openMoney('${activeDriverId}','credit')" class="bg-emerald-600 px-3 py-1 rounded text-xs">TopUp</button><button onclick="window.openMoney('${activeDriverId}','debit')" class="bg-red-600 px-3 py-1 rounded text-xs">Withdraw</button></div></div><div class="space-y-2">`;
                const trips = []; if(s.exists()) s.forEach(t => trips.push(t.val()));
                trips.sort((a,b)=>b.completedAt-a.completedAt).forEach(t => {
                    h += `<div class="bg-slate-800 p-2 rounded flex justify-between text-xs text-white"><div><div>${new Date(t.completedAt).toLocaleDateString()}</div><div class="text-slate-400">${t.pickupAddress.split(',')[0]} -> ${t.dropoffAddress.split(',')[0]}</div></div><div class="text-right font-bold text-emerald-400">+${t.fare.toLocaleString()}</div></div>`;
                });
                content.innerHTML = h + '</div>';
            }
        }

        window.removeDriver = async uid => {
            if(confirm('Are you sure? This action is permanent.')) {
                await remove(ref(db, `drivers/${uid}`));
                await remove(ref(db, `driverLocations/${uid}`));
                document.getElementById('details-modal').classList.add('hidden');
            }
        }

        // Map
        function initMap() {
            if(map) return;
            map = L.map('admin-map', {zoomControl:false}).setView([16.8, 96.1], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            
            if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p => {
                const latlng = [p.coords.latitude, p.coords.longitude];
                map.setView(latlng, 14);
                adminMarker = L.marker(latlng, {icon: L.divIcon({html:'<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white animate-pulse shadow-[0_0_10px_#3b82f6]"></div>', className:''})}).addTo(map);
            });

            document.getElementById('map-recenter-btn').onclick = () => { if(adminMarker) map.setView(adminMarker.getLatLng(), 15); else alert('Location not found'); }

            document.getElementById('map-measure-btn').onclick = () => {
                resetMeasure();
                document.getElementById('measure-info').classList.remove('hidden');
                document.getElementById('measure-results').innerHTML = '<p class="text-amber-400 font-bold">Tap Point A on Map</p>';
                map.on('click', onMapClick);
            }
        }
        
        function onMapClick(e) {
            if(!measureStart) {
                measureStart = e.latlng;
                L.marker(measureStart, {icon: L.divIcon({html:'<div class="w-3 h-3 bg-white rounded-full"></div>', className:''})}).addTo(map);
                document.getElementById('measure-results').innerHTML = '<p class="text-emerald-400 font-bold">Tap Point B on Map</p>';
            } else if (!measureEnd) {
                measureEnd = e.latlng;
                map.off('click', onMapClick);
                document.getElementById('measure-results').innerHTML = '<p class="text-blue-400 font-bold">Calculating...</p>';
                measureControl = L.Routing.control({
                    waypoints: [measureStart, measureEnd], createMarker:()=>null, addWaypoints:false, draggableWaypoints:false, show:false,
                    lineOptions: {styles:[{color:'#10b981', weight:6}]}
                }).addTo(map);
                measureControl.on('routesfound', e => {
                    const r = e.routes[0];
                    const dist = (r.summary.totalDistance/1000).toFixed(1);
                    const fare = Math.max(1500, Math.round((1500 + parseFloat(dist)*500)/100)*100);
                    document.getElementById('measure-results').innerHTML = `<div><p class="text-xs text-slate-400 uppercase">Distance</p><p class="text-lg font-bold">${dist} km</p></div><div class="mt-2 border-t border-slate-700 pt-1"><p class="text-xs text-slate-400 uppercase">Est. Fare</p><p class="text-xl font-bold text-emerald-400">${fare.toLocaleString()} MMK</p></div>`;
                });
            }
        }
        
        window.resetMeasure = () => {
            if(measureControl) { map.removeControl(measureControl); measureControl = null; }
            map.eachLayer(l => { if(l instanceof L.Marker && l !== adminMarker) map.removeLayer(l); });
            measureStart = null; measureEnd = null; map.off('click', onMapClick);
            document.getElementById('measure-info').classList.add('hidden');
        }
    </script>
</body>
</html>